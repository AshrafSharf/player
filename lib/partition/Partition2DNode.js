var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var DisplayObjectContainer = require("awayjs-display/lib/containers/DisplayObjectContainer");
var NodeBase = require("awayjs-display/lib/partition/NodeBase");
// Warning: contains horrible hacks
var Partition2DNode = (function (_super) {
    __extends(Partition2DNode, _super);
    function Partition2DNode(root) {
        _super.call(this);
        this._root = root;
    }
    Partition2DNode.prototype.acceptTraverser = function (traverser) {
        this._maskConfigID = 0;
        this._index = 0;
        if (traverser.enterNode(this)) {
            this.traverseSceneGraph(this._root, traverser);
        }
    };
    // pass any so we can convert to IEntity. Sigh, TypeScript.
    Partition2DNode.prototype.traverseSceneGraph = function (displayObject, traverser, maskID, appliedMasks) {
        if (maskID === void 0) { maskID = -1; }
        if (appliedMasks === void 0) { appliedMasks = null; }
        if (displayObject._iMaskID !== -1) {
            if (maskID !== -1)
                throw "masks within masker currently not supported";
            maskID = displayObject._iMaskID;
        }
        else {
            //console.log(displayObject._iMasks);
            if (displayObject._iMasks) {
                appliedMasks = appliedMasks ? appliedMasks.concat(displayObject._iMasks) : displayObject._iMasks;
                // signify that applied masks have changed
                ++this._maskConfigID;
            }
        }
        displayObject["hierarchicalMaskID"] = maskID;
        displayObject["hierarchicalMasks"] = appliedMasks;
        displayObject["maskConfigID"] = this._maskConfigID;
        // moving back up the tree, mask will change again
        if (displayObject._iMasks)
            ++this._maskConfigID;
        // typechecking is nasty, but we have little choice:
        if (displayObject instanceof DisplayObjectContainer)
            this.traverseChildren(displayObject, traverser, maskID, appliedMasks);
        if (displayObject.isEntity) {
            var entity = displayObject;
            entity.zOffset = ++this._index;
            entity["node2D"].acceptTraverser(traverser);
        }
    };
    Partition2DNode.prototype.traverseChildren = function (container, traverser, maskID, appliedMasks) {
        var len = container.numChildren;
        for (var i = 0; i < len; ++i)
            this.traverseSceneGraph(container.getChildAt(i), traverser, maskID, appliedMasks);
    };
    Partition2DNode.prototype.iAddNode = function (node) {
        _super.prototype.iAddNode.call(this, node);
        var entityNode = (node);
        entityNode.entity["node2D"] = node;
    };
    return Partition2DNode;
})(NodeBase);
module.exports = Partition2DNode;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1wbGF5ZXIvbGliL3BhcnRpdGlvbi9QYXJ0aXRpb24yRE5vZGUudHMiXSwibmFtZXMiOlsiUGFydGl0aW9uMkROb2RlIiwiUGFydGl0aW9uMkROb2RlLmNvbnN0cnVjdG9yIiwiUGFydGl0aW9uMkROb2RlLmFjY2VwdFRyYXZlcnNlciIsIlBhcnRpdGlvbjJETm9kZS50cmF2ZXJzZVNjZW5lR3JhcGgiLCJQYXJ0aXRpb24yRE5vZGUudHJhdmVyc2VDaGlsZHJlbiIsIlBhcnRpdGlvbjJETm9kZS5pQWRkTm9kZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBR0EsSUFBTyxzQkFBc0IsV0FBVyxzREFBc0QsQ0FBQyxDQUFDO0FBQ2hHLElBQU8sUUFBUSxXQUFXLHVDQUF1QyxDQUFDLENBQUM7QUFHbkUsQUFDQSxtQ0FEbUM7SUFDN0IsZUFBZTtJQUFTQSxVQUF4QkEsZUFBZUEsVUFBaUJBO0lBTWxDQSxTQU5FQSxlQUFlQSxDQU1MQSxJQUFrQkE7UUFFMUJDLGlCQUFPQSxDQUFDQTtRQUNSQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUN0QkEsQ0FBQ0E7SUFFTUQseUNBQWVBLEdBQXRCQSxVQUF1QkEsU0FBdUJBO1FBRTFDRSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUN2QkEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDaEJBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQzVCQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLEVBQUVBLFNBQVNBLENBQUNBLENBQUNBO1FBQ25EQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVERiwyREFBMkRBO0lBQ3BEQSw0Q0FBa0JBLEdBQXpCQSxVQUEwQkEsYUFBaUJBLEVBQUVBLFNBQXVCQSxFQUFFQSxNQUFrQkEsRUFB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LElBQUlBLENBQUNBO0lBQ3ZDQSxDQUFDQTtJQUNMTCxzQkFBQ0E7QUFBREEsQ0F6RUEsQUF5RUNBLEVBekU2QixRQUFRLEVBeUVyQztBQUNELEFBQXlCLGlCQUFoQixlQUFlLENBQUMiLCJmaWxlIjoicGFydGl0aW9uL1BhcnRpdGlvbjJETm9kZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ29sbGVjdG9yQmFzZSA9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvdHJhdmVyc2UvQ29sbGVjdG9yQmFzZVwiKTtcclxuaW1wb3J0IERpc3BsYXlPYmplY3QgPSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvRGlzcGxheU9iamVjdFwiKTtcclxuaW1wb3J0IElFbnRpdHkgPSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2VudGl0aWVzL0lFbnRpdHlcIik7XHJcbmltcG9ydCBEaXNwbGF5T2JqZWN0Q29udGFpbmVyID0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9jb250YWluZXJzL0Rpc3BsYXlPYmplY3RDb250YWluZXJcIik7XHJcbmltcG9ydCBOb2RlQmFzZSA9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvcGFydGl0aW9uL05vZGVCYXNlXCIpO1xyXG5pbXBvcnQgRW50aXR5Tm9kZSA9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvcGFydGl0aW9uL0VudGl0eU5vZGVcIik7XHJcblxyXG4vLyBXYXJuaW5nOiBjb250YWlucyBob3JyaWJsZSBoYWNrc1xyXG5jbGFzcyBQYXJ0aXRpb24yRE5vZGUgZXh0ZW5kcyBOb2RlQmFzZVxyXG57XHJcbiAgICBwcml2YXRlIF9yb290IDogRGlzcGxheU9iamVjdDtcclxuICAgIHByaXZhdGUgX21hc2tDb25maWdJRCA6IG51bWJlcjtcclxuICAgIHByaXZhdGUgX2luZGV4IDogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHJvb3Q6RGlzcGxheU9iamVjdClcclxuICAgIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMuX3Jvb3QgPSByb290O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhY2NlcHRUcmF2ZXJzZXIodHJhdmVyc2VyOkNvbGxlY3RvckJhc2UpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5fbWFza0NvbmZpZ0lEID0gMDtcclxuICAgICAgICB0aGlzLl9pbmRleCA9IDA7XHJcbiAgICAgICAgaWYgKHRyYXZlcnNlci5lbnRlck5vZGUodGhpcykpIHtcclxuICAgICAgICAgICAgdGhpcy50cmF2ZXJzZVNjZW5lR3JhcGgodGhpcy5fcm9vdCwgdHJhdmVyc2VyKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gcGFzcyBhbnkgc28gd2UgY2FuIGNvbnZlcnQgdG8gSUVudGl0eS4gU2lnaCwgVHlwZVNjcmlwdC5cclxuICAgIHB1YmxpYyB0cmF2ZXJzZVNjZW5lR3JhcGgoZGlzcGxheU9iamVjdDphbnksIHRyYXZlcnNlcjpDb2xsZWN0b3JCYXNlLCBtYXNrSUQ6bnVtYmVyID0gLTEsIGFwcGxpZWRNYXNrczpEaXNwbGF5T2JqZWN0W10gPSBudWxsKVxyXG4gICAge1xyXG4gICAgICAgIGlmIChkaXNwbGF5T2JqZWN0Ll9pTWFza0lEICE9PSAtMSkge1xyXG4gICAgICAgICAgICBpZiAobWFza0lEICE9PSAtMSkgdGhyb3cgXCJtYXNrcyB3aXRoaW4gbWFza2VyIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkXCI7XHJcbiAgICAgICAgICAgIG1hc2tJRCA9IGRpc3BsYXlPYmplY3QuX2lNYXNrSUQ7XHJcblxyXG4gICAgICAgICAgICAvLyBUT0RPOiB0aGlzIGNvdWxkIGJlIGltcGxlbWVudGVkIHNpbWlsYXIgdG8gaW1wbGljaXQgbW91c2UgZW5hYmxlZCwgcGFydGl0aW9uLCBhbmQgb3RoZXIgcGFyZW50LWNoaWxkLXByb3BhZ2F0ZWQgcHJvcGVydGllc1xyXG4gICAgICAgICAgICAvLyBqdXN0IG5vdCBzdXJlIGlmIHdlIHdhbnQgdG8ga2VlcCBpdCBsaWtlIHRoaXNcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coZGlzcGxheU9iamVjdC5faU1hc2tzKTtcclxuICAgICAgICAgICAgaWYgKGRpc3BsYXlPYmplY3QuX2lNYXNrcykge1xyXG4gICAgICAgICAgICAgICAgYXBwbGllZE1hc2tzID0gYXBwbGllZE1hc2tzPyBhcHBsaWVkTWFza3MuY29uY2F0KGRpc3BsYXlPYmplY3QuX2lNYXNrcykgOiBkaXNwbGF5T2JqZWN0Ll9pTWFza3M7XHJcbiAgICAgICAgICAgICAgICAvLyBzaWduaWZ5IHRoYXQgYXBwbGllZCBtYXNrcyBoYXZlIGNoYW5nZWRcclxuICAgICAgICAgICAgICAgICsrdGhpcy5fbWFza0NvbmZpZ0lEO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBkaXNwbGF5T2JqZWN0W1wiaGllcmFyY2hpY2FsTWFza0lEXCJdID0gbWFza0lEO1xyXG4gICAgICAgIGRpc3BsYXlPYmplY3RbXCJoaWVyYXJjaGljYWxNYXNrc1wiXSA9IGFwcGxpZWRNYXNrcztcclxuICAgICAgICBkaXNwbGF5T2JqZWN0W1wibWFza0NvbmZpZ0lEXCJdID0gdGhpcy5fbWFza0NvbmZpZ0lEO1xyXG5cclxuICAgICAgICAvLyBtb3ZpbmcgYmFjayB1cCB0aGUgdHJlZSwgbWFzayB3aWxsIGNoYW5nZSBhZ2FpblxyXG4gICAgICAgIGlmIChkaXNwbGF5T2JqZWN0Ll9pTWFza3MpXHJcbiAgICAgICAgICAgICsrdGhpcy5fbWFza0NvbmZpZ0lEO1xyXG5cclxuICAgICAgICAvLyB0eXBlY2hlY2tpbmcgaXMgbmFzdHksIGJ1dCB3ZSBoYXZlIGxpdHRsZSBjaG9pY2U6XHJcbiAgICAgICAgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBEaXNwbGF5T2JqZWN0Q29udGFpbmVyKVxyXG4gICAgICAgICAgICB0aGlzLnRyYXZlcnNlQ2hpbGRyZW4oPERpc3BsYXlPYmplY3RDb250YWluZXI+ZGlzcGxheU9iamVjdCwgdHJhdmVyc2VyLCBtYXNrSUQsIGFwcGxpZWRNYXNrcyk7XHJcblxyXG4gICAgICAgIGlmIChkaXNwbGF5T2JqZWN0LmlzRW50aXR5KSB7XHJcbiAgICAgICAgICAgIHZhciBlbnRpdHkgOiBJRW50aXR5ID0gPElFbnRpdHk+ZGlzcGxheU9iamVjdDtcclxuICAgICAgICAgICAgZW50aXR5LnpPZmZzZXQgPSArK3RoaXMuX2luZGV4O1xyXG4gICAgICAgICAgICBlbnRpdHlbXCJub2RlMkRcIl0uYWNjZXB0VHJhdmVyc2VyKHRyYXZlcnNlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdHJhdmVyc2VDaGlsZHJlbihjb250YWluZXI6RGlzcGxheU9iamVjdENvbnRhaW5lciwgdHJhdmVyc2VyOkNvbGxlY3RvckJhc2UsIG1hc2tJRDpudW1iZXIsIGFwcGxpZWRNYXNrczpEaXNwbGF5T2JqZWN0W10pXHJcbiAgICB7XHJcbiAgICAgICAgdmFyIGxlbiA9IGNvbnRhaW5lci5udW1DaGlsZHJlbjtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSlcclxuICAgICAgICAgICAgdGhpcy50cmF2ZXJzZVNjZW5lR3JhcGgoY29udGFpbmVyLmdldENoaWxkQXQoaSksIHRyYXZlcnNlciwgbWFza0lELCBhcHBsaWVkTWFza3MpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpQWRkTm9kZShub2RlOk5vZGVCYXNlKVxyXG4gICAge1xyXG4gICAgICAgIHN1cGVyLmlBZGROb2RlKG5vZGUpO1xyXG4gICAgICAgIHZhciBlbnRpdHlOb2RlID0gPEVudGl0eU5vZGU+KG5vZGUpO1xyXG4gICAgICAgIGVudGl0eU5vZGUuZW50aXR5W1wibm9kZTJEXCJdID0gbm9kZTtcclxuICAgIH1cclxufVxyXG5leHBvcnQgPSBQYXJ0aXRpb24yRE5vZGU7Il19