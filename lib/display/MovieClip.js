var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ColorTransform = require("awayjs-core/lib/geom/ColorTransform");
var DisplayObjectContainer = require("awayjs-display/lib/containers/DisplayObjectContainer");
var MovieClip = (function (_super) {
    __extends(MovieClip, _super);
    function MovieClip() {
        _super.call(this);
        this._loop = true;
        this._prototype = this;
        this._keyFrames = new Array();
        this._potentialChildren = new Array();
        this._currentFrameIndex = -1;
        this._isPlaying = true; // auto-play
        this._fps = 25;
        this._time = 0;
        this._totalFrames = 0;
    }
    Object.defineProperty(MovieClip.prototype, "adapter", {
        // adapter is used to provide MovieClip to scripts taken from different platforms
        // TODO: Perhaps adapters should be created dynamically whenever needed, rather than storing them
        get: function () {
            return this._adapter;
        },
        // setter typically managed by factor
        set: function (value) {
            this._adapter = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MovieClip.prototype, "fps", {
        get: function () {
            return this._fps;
        },
        set: function (newFps) {
            this._fps = newFps;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MovieClip.prototype, "assetType", {
        get: function () {
            return MovieClip.assetType;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Starts playback of animation from current position
     */
    MovieClip.prototype.play = function () {
        this._isPlaying = true;
    };
    /**
     * should be called right before the call to away3d-render.
     */
    MovieClip.prototype.update = function (timeDelta) {
        //this.logHierarchy();
        // TODO: Implement proper elastic racetrack logic
        var frameMarker = 1000 / this._fps;
        // right now, just advance frame once time marker has been reached
        this._time += timeDelta;
        if (this._time > frameMarker) {
            this._time = 0;
            this.advanceFrame();
        }
    };
    /**
     * Add a new TimelineFrame.
     */
    MovieClip.prototype.addFrame = function (newFrame) {
        var endFrame = Math.ceil((newFrame.startTime + newFrame.duration) / 1000 * this._fps);
        if (this._totalFrames < endFrame)
            this._totalFrames = endFrame;
        this._keyFrames.push(newFrame);
    };
    /**
     * Returns the child ID for this MovieClip
     */
    MovieClip.prototype.getPotentialChild = function (id) {
        return this._potentialChildren[id];
    };
    /**
     * Returns the child ID for this MovieClip
     */
    MovieClip.prototype.registerPotentialChild = function (prototype) {
        var id = this._potentialChildren.length;
        this._potentialChildren[id] = prototype.clone();
        return id;
    };
    MovieClip.prototype.activateChild = function (id) {
        this.addChild(this._potentialChildren[id]);
    };
    MovieClip.prototype.deactivateChild = function (id) {
        this.removeChild(this._potentialChildren[id]);
    };
    /**
     * This is called inside the TimelineFrame.execute() function.
     */
    MovieClip.prototype.executeFrameScript = function (frameScript) {
    };
    /**
     * Stop playback of animation and hold current position
     */
    MovieClip.prototype.stop = function () {
        this._isPlaying = false; // no need to call any other stuff
    };
    MovieClip.prototype.clone = function () {
        var clone = new MovieClip();
        if (this._adapter)
            clone.adapter = this._adapter.clone(clone);
        clone._prototype = this._prototype;
        clone._keyFrames = this._keyFrames;
        for (var i = 0; i < this._potentialChildren.length; ++i) {
            clone._potentialChildren[i] = this._potentialChildren[i].clone();
        }
        clone._fps = this._fps;
        clone._loop = this._loop;
        clone._totalFrames = this._totalFrames;
        clone.name = this.name;
        if (this.transform.matrix)
            clone.transform.matrix = this.transform.matrix.clone();
        clone.transform.matrix3D = this.transform.matrix3D;
        var ct = this.transform.colorTransform;
        if (ct)
            clone.transform.colorTransform = new ColorTransform(ct.redMultiplier, ct.greenMultiplier, ct.blueMultiplier, ct.alphaMultiplier, ct.redOffset, ct.greenOffset, ct.blueOffset, ct.alphaOffset);
        return clone;
    };
    MovieClip.prototype.resetPlayHead = function () {
        this._time = 0;
        this._currentFrameIndex = 0;
        for (var i = this.numChildren - 1; i >= 0; --i)
            this.removeChildAt(i);
        for (var i = 0; i < this._keyFrames.length; ++i) {
            var keyFrame = this._keyFrames[i];
            // deactivate any currently active keyframes first
            if (keyFrame.isActive)
                keyFrame.deactivate(this);
        }
    };
    MovieClip.prototype.advanceFrame = function (skipFrames) {
        if (skipFrames === void 0) { skipFrames = false; }
        var i;
        var advance = this._isPlaying;
        if (advance && this._currentFrameIndex == this._totalFrames - 1 && !this._loop) {
            advance = false;
        }
        if (advance && this._currentFrameIndex <= 0 && this._totalFrames == 1) {
            this._currentFrameIndex = 0;
            advance = false;
        }
        if (advance) {
            if (++this._currentFrameIndex == this._totalFrames)
                this.resetPlayHead();
        }
        this.updateKeyFrames(skipFrames);
        // advance children
        if (!skipFrames) {
            var len = this.numChildren;
            for (i = 0; i < len; i++) {
                var child = this.getChildAt(i);
                if (child instanceof MovieClip)
                    child.advanceFrame(skipFrames);
            }
        }
    };
    MovieClip.prototype.updateKeyFrames = function (skipFrames) {
        // TODO: Switch to frames over time (so we can check with ==, instead of > and active)
        var time = this._currentFrameIndex / this._fps * 1000;
        for (var i = 0; i < this._keyFrames.length; ++i) {
            var keyFrame = this._keyFrames[i];
            if (time >= keyFrame.startTime && time <= keyFrame.endTime && !keyFrame.isActive)
                keyFrame.activate(this);
            if (time >= keyFrame.endTime && keyFrame.isActive)
                keyFrame.deactivate(this);
            if (!skipFrames && keyFrame.isActive)
                keyFrame.update(this, this._time);
        }
    };
    // DEBUG CODE:
    MovieClip.prototype.logHierarchy = function (depth) {
        if (depth === void 0) { depth = 0; }
        this.printHierarchyName(depth, this);
        var len = this.numChildren;
        for (var i = 0; i < len; i++) {
            var child = this.getChildAt(i);
            if (child instanceof MovieClip)
                child.logHierarchy(depth + 1);
            else
                this.printHierarchyName(depth + 1, child);
        }
    };
    MovieClip.prototype.printHierarchyName = function (depth, target) {
        var str = "";
        for (var i = 0; i < depth; ++i)
            str += "--";
        str += " " + target.name;
        console.log(str);
    };
    MovieClip.assetType = "[asset MovieClip]";
    return MovieClip;
})(DisplayObjectContainer);
module.exports = MovieClip;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1wbGF5ZXIvbGliL2Rpc3BsYXkvTW92aWVDbGlwLnRzIl0sIm5hbWVzIjpbIk1vdmllQ2xpcCIsIk1vdmllQ2xpcC5jb25zdHJ1Y3RvciIsIk1vdmllQ2xpcC5hZGFwdGVyIiwiTW92aWVDbGlwLmZwcyIsIk1vdmllQ2xpcC5hc3NldFR5cGUiLCJNb3ZpZUNsaXAucGxheSIsIk1vdmllQ2xpcC51cGRhdGUiLCJNb3ZpZUNsaXAuYWRkRnJhbWUiLCJNb3ZpZUNsaXAuZ2V0UG90ZW50aWFsQ2hpbGQiLCJNb3ZpZUNsaXAucmVnaXN0ZXJQb3RlbnRpYWxDaGlsZCIsIk1vdmllQ2xpcC5hY3RpdmF0ZUNoaWxkIiwiTW92aWVDbGlwLmRlYWN0aXZhdGVDaGlsZCIsIk1vdmllQ2xpcC5leGVjdXRlRnJhbWVTY3JpcHQiLCJNb3ZpZUNsaXAuc3RvcCIsIk1vdmllQ2xpcC5jbG9uZSIsIk1vdmllQ2xpcC5yZXNldFBsYXlIZWFkIiwiTW92aWVDbGlwLmFkdmFuY2VGcmFtZSIsIk1vdmllQ2xpcC51cGRhdGVLZXlGcmFtZXMiLCJNb3ZpZUNsaXAubG9nSGllcmFyY2h5IiwiTW92aWVDbGlwLnByaW50SGllcmFyY2h5TmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxjQUFjLFdBQVcscUNBQXFDLENBQUMsQ0FBQztBQUV2RSxJQUFPLHNCQUFzQixXQUFXLHNEQUFzRCxDQUFDLENBQUM7QUFNaEcsSUFBTSxTQUFTO0lBQVNBLFVBQWxCQSxTQUFTQSxVQUErQkE7SUFrQjFDQSxTQWxCRUEsU0FBU0E7UUFvQlBDLGlCQUFPQSxDQUFDQTtRQVhKQSxVQUFLQSxHQUFXQSxJQUFJQSxDQUFDQTtRQVl6QkEsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDdkJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLEtBQUtBLEVBQW9CQSxDQUFDQTtRQUNoREEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxJQUFJQSxLQUFLQSxFQUFpQkEsQ0FBQ0E7UUFDckRBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDN0JBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLEVBQUVBLFlBQVlBO1FBQ3BDQSxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUNmQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUNmQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUMxQkEsQ0FBQ0E7SUFJREQsc0JBQVdBLDhCQUFPQTtRQUZsQkEsaUZBQWlGQTtRQUNqRkEsaUdBQWlHQTthQUNqR0E7WUFFSUUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7UUFDekJBLENBQUNBO1FBRURGLHFDQUFxQ0E7YUFDckNBLFVBQW1CQSxLQUFzQkE7WUFFckNFLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBLEtBQUtBLENBQUNBO1FBQzFCQSxDQUFDQTs7O09BTkFGO0lBUURBLHNCQUFXQSwwQkFBR0E7YUFBZEE7WUFFSUcsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDckJBLENBQUNBO2FBRURILFVBQWVBLE1BQWFBO1lBRXhCRyxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxNQUFNQSxDQUFDQTtRQUN2QkEsQ0FBQ0E7OztPQUxBSDtJQU9EQSxzQkFBV0EsZ0NBQVNBO2FBQXBCQTtZQUVJSSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQSxTQUFTQSxDQUFDQTtRQUMvQkEsQ0FBQ0E7OztPQUFBSjtJQUVEQTs7T0FFR0E7SUFDSUEsd0JBQUlBLEdBQVhBO1FBRUlLLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBO0lBQzNCQSxDQUFDQTtJQUVETDs7T0FFR0E7SUFDSUEsMEJBQU1BLEdBQWJBLFVBQWNBLFNBQWdCQTtRQUUxQk0sQUFFQUEsc0JBRnNCQTtRQUN0QkEsaURBQWlEQTtZQUM3Q0EsV0FBV0EsR0FBWUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFFNUNBLEFBQ0FBLGtFQURrRUE7UUFDbEVBLElBQUlBLENBQUNBLEtBQUtBLElBQUlBLFNBQVNBLENBQUNBO1FBRXhCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMzQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDZkEsSUFBSUEsQ0FBQ0EsWUFBWUEsRUFBRUEsQ0FBQ0E7UUFDeEJBLENBQUNBO0lBQ0xBLENBQUNBO0lBRUROOztPQUVHQTtJQUNJQSw0QkFBUUEsR0FBZkEsVUFBZ0JBLFFBQXlCQTtRQUVyQ08sSUFBSUEsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsU0FBU0EsR0FBR0EsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDdEZBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLEdBQUdBLFFBQVFBLENBQUNBO1lBQzdCQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxRQUFRQSxDQUFDQTtRQUNqQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDbkNBLENBQUNBO0lBRURQOztPQUVHQTtJQUNJQSxxQ0FBaUJBLEdBQXhCQSxVQUF5QkEsRUFBU0E7UUFFOUJRLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7SUFDdkNBLENBQUNBO0lBRURSOztPQUVHQTtJQUNJQSwwQ0FBc0JBLEdBQTdCQSxVQUE4QkEsU0FBdUJBO1FBRWpEUyxJQUFJQSxFQUFFQSxHQUFHQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLE1BQU1BLENBQUNBO1FBQ3hDQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLFNBQVNBLENBQUNBLEtBQUtBLEVBQUVBLENBQUNBO1FBQ2hEQSxNQUFNQSxDQUFDQSxFQUFFQSxDQUFDQTtJQUNkQSxDQUFDQTtJQUVNVCxpQ0FBYUEsR0FBcEJBLFVBQXFCQSxFQUFTQTtRQUUxQlUsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUMvQ0EsQ0FBQ0E7SUFFTVYsbUNBQWVBLEdBQXRCQSxVQUF1QkEsRUFBU0E7UUFFNUJXLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDbERBLENBQUNBO0lBRURYOztPQUVHQTtJQUNLQSxzQ0FBa0JBLEdBQTFCQSxVQUEyQkEsV0FBa0JBO0lBRzdDWSxDQUFDQTtJQUVEWjs7T0FFR0E7SUFDSUEsd0JBQUlBLEdBQVhBO1FBRUlhLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLEtBQUtBLEVBQUNBLGtDQUFrQ0E7SUFDOURBLENBQUNBLEdBRDJCQTtJQUdyQmIseUJBQUtBLEdBQVpBO1FBRUljLElBQUlBLEtBQUtBLEdBQWFBLElBQUlBLFNBQVNBLEVBQUVBLENBQUNBO1FBRXRDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQTtZQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUM5REEsS0FBS0EsQ0FBQ0EsVUFBVUEsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0E7UUFDbkNBLEtBQUtBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBO1FBRW5DQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLE1BQU1BLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBO1lBQ3REQSxLQUFLQSxDQUFDQSxrQkFBa0JBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7UUFDckVBLENBQUNBO1FBRURBLEtBQUtBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBO1FBQ3ZCQSxLQUFLQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUN6QkEsS0FBS0EsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0E7UUFDdkNBLEtBQUtBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBO1FBRXZCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQTtZQUN0QkEsS0FBS0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7UUFFM0RBLEtBQUtBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLENBQUNBO1FBRW5EQSxJQUFJQSxFQUFFQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxjQUFjQSxDQUFDQTtRQUN2Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0E7WUFBQ0EsS0FBS0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsY0FBY0EsR0FBR0EsSUFBSUEsY0FBY0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsYUFBYUEsRUFBRUEsRUFBRUEsQ0FBQ0EsZUFBZUEsRUFBRUEsRUFBRUEsQ0FBQ0EsY0FBY0EsRUFBRUEsRUFBRUEsQ0FBQ0Es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QUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDL0JBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLFlBQVlBLFNBQVNBLENBQUNBO29CQUNmQSxLQUFNQSxDQUFDQSxZQUFZQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtZQUNwREEsQ0FBQ0E7UUFRTEEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFT2hCLG1DQUFlQSxHQUF2QkEsVUFBd0JBLFVBQWtCQTtRQUV0Q2lCLHNGQUFzRkE7UUFFdEZBLElBQUlBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFdERBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLE1BQU1BLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBO1lBQzlDQSxJQUFJQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUVsQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsSUFBSUEsUUFBUUEsQ0FBQ0EsU0FBU0EsSUFBSUEsSUFBSUEsSUFBSUEsUUFBUUEsQ0FBQ0EsT0FBT0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7Z0JBQzdFQSxRQUFRQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUU1QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsSUFBSUEsUUFBUUEsQ0FBQ0EsT0FBT0EsSUFBSUEsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7Z0JBQzlDQSxRQUFRQSxDQUFDQSxVQUFVQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUU5QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsVUFBVUEsSUFBSUEsUUFBUUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7Z0JBQ2pDQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUMxQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFTGpCLGNBQWNBO0lBQ1ZBLGdDQUFZQSxHQUFaQSxVQUFhQSxLQUFpQkE7UUFBakJrQixxQkFBaUJBLEdBQWpCQSxTQUFpQkE7UUFFMUJBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFFckNBLElBQUlBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBO1FBQzNCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUMzQkEsSUFBSUEsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFL0JBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLFlBQVlBLFNBQVNBLENBQUNBO2dCQUNmQSxLQUFNQSxDQUFDQSxZQUFZQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMvQ0EsSUFBSUE7Z0JBQ0FBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDbERBLENBQUNBO0lBQ0xBLENBQUNBO0lBRURsQixzQ0FBa0JBLEdBQWxCQSxVQUFtQkEsS0FBWUEsRUFBRUEsTUFBb0JBO1FBRWpEbUIsSUFBSUEsR0FBR0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDYkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsS0FBS0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDMUJBLEdBQUdBLElBQUlBLElBQUlBLENBQUNBO1FBRWhCQSxHQUFHQSxJQUFJQSxHQUFHQSxHQUFHQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUN6QkEsT0FBT0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFDckJBLENBQUNBO0lBeFFVbkIsbUJBQVNBLEdBQVVBLG1CQUFtQkEsQ0FBQ0E7SUF5UXREQSxnQkFBQ0E7QUFBREEsQ0EzUUEsQUEyUUNBLEVBM1F1QixzQkFBc0IsRUEyUTdDO0FBQ0QsQUFBbUIsaUJBQVYsU0FBUyxDQUFDIiwiZmlsZSI6ImRpc3BsYXkvTW92aWVDbGlwLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb2xvclRyYW5zZm9ybSA9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9Db2xvclRyYW5zZm9ybVwiKTtcbmltcG9ydCBJQXNzZXQgPSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2xpYnJhcnkvSUFzc2V0XCIpO1xuaW1wb3J0IERpc3BsYXlPYmplY3RDb250YWluZXIgPSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2NvbnRhaW5lcnMvRGlzcGxheU9iamVjdENvbnRhaW5lclwiKTtcbmltcG9ydCBEaXNwbGF5T2JqZWN0ID0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0Rpc3BsYXlPYmplY3RcIik7XG5cbmltcG9ydCBNb3ZpZUNsaXBBZGFwdGVyID0gcmVxdWlyZShcImF3YXlqcy1wbGF5ZXIvbGliL2FkYXB0ZXJzL01vdmllQ2xpcEFkYXB0ZXJcIik7XG5pbXBvcnQgVGltZWxpbmVLZXlGcmFtZSA9IHJlcXVpcmUoXCJhd2F5anMtcGxheWVyL2xpYi90aW1lbGluZS9UaW1lbGluZUtleUZyYW1lXCIpO1xuXG5jbGFzcyBNb3ZpZUNsaXAgZXh0ZW5kcyBEaXNwbGF5T2JqZWN0Q29udGFpbmVyXG57XG5cdHB1YmxpYyBzdGF0aWMgYXNzZXRUeXBlOnN0cmluZyA9IFwiW2Fzc2V0IE1vdmllQ2xpcF1cIjtcblxuICAgIHByaXZhdGUgX2tleUZyYW1lczpBcnJheTxUaW1lbGluZUtleUZyYW1lPjtcbiAgICBwcml2YXRlIF90aW1lOm51bWJlcjsvLyB0aGUgY3VycmVudCB0aW1lIGluc2lkZSB0aGUgYW5pbWF0aW9uXG4gICAgcHJpdmF0ZSBfY3VycmVudEZyYW1lSW5kZXg6bnVtYmVyOy8vIHRoZSBjdXJyZW50IGZyYW1lXG4gICAgcHJpdmF0ZSBfZnBzOm51bWJlcjsvLyB3ZSB1c2UgbXMgaW50ZXJuYWxseSwgYnV0IGhhdmUgZnBzLCBzbyB1c2VyIGNhbiBzZXQgdGltZSBieSBmcmFtZVxuICAgIHByaXZhdGUgX2lzUGxheWluZzpib29sZWFuOy8vIGZhbHNlIGlmIHBhdXNlZCBvciBzdG9wcGVkXG4gICAgcHJpdmF0ZSBfbG9vcDpib29sZWFuID0gdHJ1ZTtcbiAgICBwcml2YXRlIF90b3RhbEZyYW1lczpudW1iZXI7XG4gICAgLy8gbm90IHN1cmUgaWYgbmVlZGVkXG4gICAgcHJpdmF0ZSBfcHJvdG90eXBlOk1vdmllQ2xpcDtcblxuICAgIHByaXZhdGUgX2FkYXB0ZXI6TW92aWVDbGlwQWRhcHRlcjtcblxuICAgIHByaXZhdGUgX3BvdGVudGlhbENoaWxkcmVuOkFycmF5PERpc3BsYXlPYmplY3Q+O1xuXG4gICAgY29uc3RydWN0b3IoKVxuICAgIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5fcHJvdG90eXBlID0gdGhpcztcbiAgICAgICAgdGhpcy5fa2V5RnJhbWVzID0gbmV3IEFycmF5PFRpbWVsaW5lS2V5RnJhbWU+KCk7XG4gICAgICAgIHRoaXMuX3BvdGVudGlhbENoaWxkcmVuID0gbmV3IEFycmF5PERpc3BsYXlPYmplY3Q+KCk7XG4gICAgICAgIHRoaXMuX2N1cnJlbnRGcmFtZUluZGV4ID0gLTE7XG4gICAgICAgIHRoaXMuX2lzUGxheWluZyA9IHRydWU7IC8vIGF1dG8tcGxheVxuICAgICAgICB0aGlzLl9mcHMgPSAyNTtcbiAgICAgICAgdGhpcy5fdGltZSA9IDA7XG4gICAgICAgIHRoaXMuX3RvdGFsRnJhbWVzID0gMDtcbiAgICB9XG5cbiAgICAvLyBhZGFwdGVyIGlzIHVzZWQgdG8gcHJvdmlkZSBNb3ZpZUNsaXAgdG8gc2NyaXB0cyB0YWtlbiBmcm9tIGRpZmZlcmVudCBwbGF0Zm9ybXNcbiAgICAvLyBUT0RPOiBQZXJoYXBzIGFkYXB0ZXJzIHNob3VsZCBiZSBjcmVhdGVkIGR5bmFtaWNhbGx5IHdoZW5ldmVyIG5lZWRlZCwgcmF0aGVyIHRoYW4gc3RvcmluZyB0aGVtXG4gICAgcHVibGljIGdldCBhZGFwdGVyKCk6TW92aWVDbGlwQWRhcHRlclxuICAgIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FkYXB0ZXI7XG4gICAgfVxuXG4gICAgLy8gc2V0dGVyIHR5cGljYWxseSBtYW5hZ2VkIGJ5IGZhY3RvclxuICAgIHB1YmxpYyBzZXQgYWRhcHRlcih2YWx1ZTpNb3ZpZUNsaXBBZGFwdGVyKVxuICAgIHtcbiAgICAgICAgdGhpcy5fYWRhcHRlciA9IHZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgZnBzKCk6bnVtYmVyXG4gICAge1xuICAgICAgICByZXR1cm4gdGhpcy5fZnBzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgZnBzKG5ld0ZwczpudW1iZXIpXG4gICAge1xuICAgICAgICB0aGlzLl9mcHMgPSBuZXdGcHM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBhc3NldFR5cGUoKTpzdHJpbmdcbiAgICB7XG4gICAgICAgIHJldHVybiBNb3ZpZUNsaXAuYXNzZXRUeXBlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0cyBwbGF5YmFjayBvZiBhbmltYXRpb24gZnJvbSBjdXJyZW50IHBvc2l0aW9uXG4gICAgICovXG4gICAgcHVibGljIHBsYXkoKVxuICAgIHtcbiAgICAgICAgdGhpcy5faXNQbGF5aW5nID0gdHJ1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBzaG91bGQgYmUgY2FsbGVkIHJpZ2h0IGJlZm9yZSB0aGUgY2FsbCB0byBhd2F5M2QtcmVuZGVyLlxuICAgICAqL1xuICAgIHB1YmxpYyB1cGRhdGUodGltZURlbHRhOm51bWJlcilcbiAgICB7XG4gICAgICAgIC8vdGhpcy5sb2dIaWVyYXJjaHkoKTtcbiAgICAgICAgLy8gVE9ETzogSW1wbGVtZW50IHByb3BlciBlbGFzdGljIHJhY2V0cmFjayBsb2dpY1xuICAgICAgICB2YXIgZnJhbWVNYXJrZXIgOiBudW1iZXIgPSAxMDAwIC8gdGhpcy5fZnBzO1xuXG4gICAgICAgIC8vIHJpZ2h0IG5vdywganVzdCBhZHZhbmNlIGZyYW1lIG9uY2UgdGltZSBtYXJrZXIgaGFzIGJlZW4gcmVhY2hlZFxuICAgICAgICB0aGlzLl90aW1lICs9IHRpbWVEZWx0YTtcblxuICAgICAgICBpZiAodGhpcy5fdGltZSA+IGZyYW1lTWFya2VyKSB7XG4gICAgICAgICAgICB0aGlzLl90aW1lID0gMDtcbiAgICAgICAgICAgIHRoaXMuYWR2YW5jZUZyYW1lKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBuZXcgVGltZWxpbmVGcmFtZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgYWRkRnJhbWUobmV3RnJhbWU6VGltZWxpbmVLZXlGcmFtZSlcbiAgICB7XG4gICAgICAgIHZhciBlbmRGcmFtZSA9IE1hdGguY2VpbCgobmV3RnJhbWUuc3RhcnRUaW1lICsgbmV3RnJhbWUuZHVyYXRpb24pIC8gMTAwMCAqIHRoaXMuX2Zwcyk7XG4gICAgICAgIGlmICh0aGlzLl90b3RhbEZyYW1lcyA8IGVuZEZyYW1lKVxuICAgICAgICAgICAgdGhpcy5fdG90YWxGcmFtZXMgPSBlbmRGcmFtZTtcbiAgICAgICAgdGhpcy5fa2V5RnJhbWVzLnB1c2gobmV3RnJhbWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIGNoaWxkIElEIGZvciB0aGlzIE1vdmllQ2xpcFxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRQb3RlbnRpYWxDaGlsZChpZDpudW1iZXIpIDogRGlzcGxheU9iamVjdFxuICAgIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3BvdGVudGlhbENoaWxkcmVuW2lkXTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRoZSBjaGlsZCBJRCBmb3IgdGhpcyBNb3ZpZUNsaXBcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVnaXN0ZXJQb3RlbnRpYWxDaGlsZChwcm90b3R5cGU6RGlzcGxheU9iamVjdCkgOiBudW1iZXJcbiAgICB7XG4gICAgICAgIHZhciBpZCA9IHRoaXMuX3BvdGVudGlhbENoaWxkcmVuLmxlbmd0aDtcbiAgICAgICAgdGhpcy5fcG90ZW50aWFsQ2hpbGRyZW5baWRdID0gcHJvdG90eXBlLmNsb25lKCk7XG4gICAgICAgIHJldHVybiBpZDtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWN0aXZhdGVDaGlsZChpZDpudW1iZXIpXG4gICAge1xuICAgICAgICB0aGlzLmFkZENoaWxkKHRoaXMuX3BvdGVudGlhbENoaWxkcmVuW2lkXSk7XG4gICAgfVxuXG4gICAgcHVibGljIGRlYWN0aXZhdGVDaGlsZChpZDpudW1iZXIpXG4gICAge1xuICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX3BvdGVudGlhbENoaWxkcmVuW2lkXSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBpcyBjYWxsZWQgaW5zaWRlIHRoZSBUaW1lbGluZUZyYW1lLmV4ZWN1dGUoKSBmdW5jdGlvbi5cbiAgICAgKi9cbiAgICBwcml2YXRlIGV4ZWN1dGVGcmFtZVNjcmlwdChmcmFtZVNjcmlwdDpzdHJpbmcpXG4gICAge1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCBwbGF5YmFjayBvZiBhbmltYXRpb24gYW5kIGhvbGQgY3VycmVudCBwb3NpdGlvblxuICAgICAqL1xuICAgIHB1YmxpYyBzdG9wKClcbiAgICB7XG4gICAgICAgIHRoaXMuX2lzUGxheWluZyA9IGZhbHNlOy8vIG5vIG5lZWQgdG8gY2FsbCBhbnkgb3RoZXIgc3R1ZmZcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xvbmUoKSA6IERpc3BsYXlPYmplY3RcbiAgICB7XG4gICAgICAgIHZhciBjbG9uZTpNb3ZpZUNsaXAgPSBuZXcgTW92aWVDbGlwKCk7XG5cbiAgICAgICAgaWYgKHRoaXMuX2FkYXB0ZXIpIGNsb25lLmFkYXB0ZXIgPSB0aGlzLl9hZGFwdGVyLmNsb25lKGNsb25lKTtcbiAgICAgICAgY2xvbmUuX3Byb3RvdHlwZSA9IHRoaXMuX3Byb3RvdHlwZTtcbiAgICAgICAgY2xvbmUuX2tleUZyYW1lcyA9IHRoaXMuX2tleUZyYW1lcztcblxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3BvdGVudGlhbENoaWxkcmVuLmxlbmd0aDsgKytpKSB7XG4gICAgICAgICAgICBjbG9uZS5fcG90ZW50aWFsQ2hpbGRyZW5baV0gPSB0aGlzLl9wb3RlbnRpYWxDaGlsZHJlbltpXS5jbG9uZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgY2xvbmUuX2ZwcyA9IHRoaXMuX2ZwcztcbiAgICAgICAgY2xvbmUuX2xvb3AgPSB0aGlzLl9sb29wO1xuICAgICAgICBjbG9uZS5fdG90YWxGcmFtZXMgPSB0aGlzLl90b3RhbEZyYW1lcztcbiAgICAgICAgY2xvbmUubmFtZSA9IHRoaXMubmFtZTtcblxuICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0ubWF0cml4KVxuICAgICAgICAgICAgY2xvbmUudHJhbnNmb3JtLm1hdHJpeCA9IHRoaXMudHJhbnNmb3JtLm1hdHJpeC5jbG9uZSgpO1xuXG4gICAgICAgIGNsb25lLnRyYW5zZm9ybS5tYXRyaXgzRCA9IHRoaXMudHJhbnNmb3JtLm1hdHJpeDNEO1xuXG4gICAgICAgIHZhciBjdCA9IHRoaXMudHJhbnNmb3JtLmNvbG9yVHJhbnNmb3JtO1xuICAgICAgICBpZiAoY3QpIGNsb25lLnRyYW5zZm9ybS5jb2xvclRyYW5zZm9ybSA9IG5ldyBDb2xvclRyYW5zZm9ybShjdC5yZWRNdWx0aXBsaWVyLCBjdC5ncmVlbk11bHRpcGxpZXIsIGN0LmJsdWVNdWx0aXBsaWVyLCBjdC5hbHBoYU11bHRpcGxpZXIsIGN0LnJlZE9mZnNldCwgY3QuZ3JlZW5PZmZzZXQsIGN0LmJsdWVPZmZzZXQsIGN0LmFscGhhT2Zmc2V0KTtcblxuICAgICAgICByZXR1cm4gY2xvbmU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNldFBsYXlIZWFkKClcbiAgICB7XG4gICAgICAgIHRoaXMuX3RpbWUgPSAwO1xuICAgICAgICB0aGlzLl9jdXJyZW50RnJhbWVJbmRleCA9IDA7XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMubnVtQ2hpbGRyZW4gLSAxOyBpID49IDA7IC0taSlcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2hpbGRBdChpKTtcblxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX2tleUZyYW1lcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgdmFyIGtleUZyYW1lID0gdGhpcy5fa2V5RnJhbWVzW2ldO1xuXG4gICAgICAgICAgICAvLyBkZWFjdGl2YXRlIGFueSBjdXJyZW50bHkgYWN0aXZlIGtleWZyYW1lcyBmaXJzdFxuICAgICAgICAgICAgaWYgKGtleUZyYW1lLmlzQWN0aXZlKVxuICAgICAgICAgICAgICAgIGtleUZyYW1lLmRlYWN0aXZhdGUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFkdmFuY2VGcmFtZShza2lwRnJhbWVzOmJvb2xlYW4gPSBmYWxzZSlcbiAgICB7XG4gICAgICAgIHZhciBpO1xuICAgICAgICB2YXIgYWR2YW5jZSA9IHRoaXMuX2lzUGxheWluZztcbiAgICAgICAgaWYgKGFkdmFuY2UgJiYgdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPT0gdGhpcy5fdG90YWxGcmFtZXMgLSAxICYmICF0aGlzLl9sb29wKSB7XG4gICAgICAgICAgICBhZHZhbmNlID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFkdmFuY2UgJiYgdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPD0gMCAmJiB0aGlzLl90b3RhbEZyYW1lcyA9PSAxKSB7XG4gICAgICAgICAgICB0aGlzLl9jdXJyZW50RnJhbWVJbmRleCA9IDA7XG4gICAgICAgICAgICBhZHZhbmNlID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYWR2YW5jZSkge1xuICAgICAgICAgICAgaWYgKCsrdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPT0gdGhpcy5fdG90YWxGcmFtZXMpXG4gICAgICAgICAgICAgICAgdGhpcy5yZXNldFBsYXlIZWFkKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnVwZGF0ZUtleUZyYW1lcyhza2lwRnJhbWVzKTtcblxuICAgICAgICAvLyBhZHZhbmNlIGNoaWxkcmVuXG4gICAgICAgIGlmICghc2tpcEZyYW1lcykge1xuICAgICAgICAgICAgdmFyIGxlbiA9IHRoaXMubnVtQ2hpbGRyZW47XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLmdldENoaWxkQXQoaSk7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgTW92aWVDbGlwKVxuICAgICAgICAgICAgICAgICAgICAoPE1vdmllQ2xpcD5jaGlsZCkuYWR2YW5jZUZyYW1lKHNraXBGcmFtZXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBUT0RPOiBOb3Qgc3VyZSB3aGF0IGRlZmVycmVkIGNoaWxkcmVuIGFyZS4gQ2hlY2sgdy8gQ2xhdXMuXG4gICAgICAgICAgICAvKmZvciAoaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuRGVmZXJyZWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbkRlZmVycmVkW2ldLmRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBNb3ZpZUNsaXApIHtcbiAgICAgICAgICAgICAoPE1vdmllQ2xpcD50aGlzLmNoaWxkcmVuRGVmZXJyZWRbaV0uZGlzcGxheU9iamVjdCkuYWR2YW5jZUZyYW1lKGEpO1xuICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICB9Ki9cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlS2V5RnJhbWVzKHNraXBGcmFtZXM6Ym9vbGVhbilcbiAgICB7XG4gICAgICAgIC8vIFRPRE86IFN3aXRjaCB0byBmcmFtZXMgb3ZlciB0aW1lIChzbyB3ZSBjYW4gY2hlY2sgd2l0aCA9PSwgaW5zdGVhZCBvZiA+IGFuZCBhY3RpdmUpXG5cbiAgICAgICAgdmFyIHRpbWUgPSB0aGlzLl9jdXJyZW50RnJhbWVJbmRleCAvIHRoaXMuX2ZwcyAqIDEwMDA7XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9rZXlGcmFtZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgIHZhciBrZXlGcmFtZSA9IHRoaXMuX2tleUZyYW1lc1tpXTtcblxuICAgICAgICAgICAgaWYgKHRpbWUgPj0ga2V5RnJhbWUuc3RhcnRUaW1lICYmIHRpbWUgPD0ga2V5RnJhbWUuZW5kVGltZSAmJiAha2V5RnJhbWUuaXNBY3RpdmUpXG4gICAgICAgICAgICAgICAga2V5RnJhbWUuYWN0aXZhdGUodGhpcyk7XG5cbiAgICAgICAgICAgIGlmICh0aW1lID49IGtleUZyYW1lLmVuZFRpbWUgJiYga2V5RnJhbWUuaXNBY3RpdmUpXG4gICAgICAgICAgICAgICAga2V5RnJhbWUuZGVhY3RpdmF0ZSh0aGlzKTtcblxuICAgICAgICAgICAgaWYgKCFza2lwRnJhbWVzICYmIGtleUZyYW1lLmlzQWN0aXZlKVxuICAgICAgICAgICAgICAgIGtleUZyYW1lLnVwZGF0ZSh0aGlzLCB0aGlzLl90aW1lKTtcbiAgICAgICAgfVxuICAgIH1cblxuLy8gREVCVUcgQ09ERTpcbiAgICBsb2dIaWVyYXJjaHkoZGVwdGg6IG51bWJlciA9IDApOnZvaWRcbiAgICB7XG4gICAgICAgIHRoaXMucHJpbnRIaWVyYXJjaHlOYW1lKGRlcHRoLCB0aGlzKTtcblxuICAgICAgICB2YXIgbGVuID0gdGhpcy5udW1DaGlsZHJlbjtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5nZXRDaGlsZEF0KGkpO1xuXG4gICAgICAgICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBNb3ZpZUNsaXApXG4gICAgICAgICAgICAgICAgKDxNb3ZpZUNsaXA+Y2hpbGQpLmxvZ0hpZXJhcmNoeShkZXB0aCArIDEpO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHRoaXMucHJpbnRIaWVyYXJjaHlOYW1lKGRlcHRoICsgMSwgY2hpbGQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpbnRIaWVyYXJjaHlOYW1lKGRlcHRoOm51bWJlciwgdGFyZ2V0OkRpc3BsYXlPYmplY3QpXG4gICAge1xuICAgICAgICB2YXIgc3RyID0gXCJcIjtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXB0aDsgKytpKVxuICAgICAgICAgICAgc3RyICs9IFwiLS1cIjtcblxuICAgICAgICBzdHIgKz0gXCIgXCIgKyB0YXJnZXQubmFtZTtcbiAgICAgICAgY29uc29sZS5sb2coc3RyKTtcbiAgICB9XG59XG5leHBvcnQgPSBNb3ZpZUNsaXA7XG4iXX0=