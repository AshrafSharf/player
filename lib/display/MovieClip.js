var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ColorTransform = require("awayjs-core/lib/geom/ColorTransform");
var DisplayObjectContainer = require("awayjs-display/lib/containers/DisplayObjectContainer");
var MovieClip = (function (_super) {
    __extends(MovieClip, _super);
    function MovieClip() {
        _super.call(this);
        this._loop = true;
        this._prototype = this;
        this._keyFrames = new Array();
        this._potentialChildren = new Array();
        this._currentFrameIndex = -1;
        this._isPlaying = true; // auto-play
        this._fps = 25;
        this._time = 0;
        this._totalFrames = 0;
    }
    Object.defineProperty(MovieClip.prototype, "adapter", {
        // adapter is used to provide MovieClip to scripts taken from different platforms
        // TODO: Perhaps adapters should be created dynamically whenever needed, rather than storing them
        get: function () {
            return this._adapter;
        },
        // setter typically managed by factor
        set: function (value) {
            this._adapter = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MovieClip.prototype, "fps", {
        get: function () {
            return this._fps;
        },
        set: function (newFps) {
            this._fps = newFps;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MovieClip.prototype, "assetType", {
        get: function () {
            return MovieClip.assetType;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Starts playback of animation from current position
     */
    MovieClip.prototype.play = function () {
        this._isPlaying = true;
    };
    /**
     * should be called right before the call to away3d-render.
     */
    MovieClip.prototype.update = function (timeDelta) {
        //this.logHierarchy();
        // TODO: Implement proper elastic racetrack logic
        var frameMarker = 1000 / this._fps;
        // right now, just advance frame once time marker has been reached
        this._time += timeDelta;
        if (this._time > frameMarker) {
            this._time = 0;
            this.advanceFrame();
        }
    };
    /**
     * Add a new TimelineFrame.
     */
    MovieClip.prototype.addFrame = function (newFrame) {
        var endFrame = Math.ceil((newFrame.startTime + newFrame.duration) / 1000 * this._fps);
        if (this._totalFrames < endFrame)
            this._totalFrames = endFrame;
        this._keyFrames.push(newFrame);
    };
    /**
     * Returns the child ID for this MovieClip
     */
    MovieClip.prototype.getPotentialChild = function (id) {
        return this._potentialChildren[id];
    };
    /**
     * Returns the child ID for this MovieClip
     */
    MovieClip.prototype.registerPotentialChild = function (prototype) {
        var id = this._potentialChildren.length;
        this._potentialChildren[id] = prototype.clone();
        return id;
    };
    MovieClip.prototype.activateChild = function (id) {
        this.addChild(this._potentialChildren[id]);
    };
    MovieClip.prototype.deactivateChild = function (id) {
        this.removeChild(this._potentialChildren[id]);
    };
    /**
     * This is called inside the TimelineFrame.execute() function.
     */
    MovieClip.prototype.executeFrameScript = function (frameScript) {
    };
    /**
     * Stop playback of animation and hold current position
     */
    MovieClip.prototype.stop = function () {
        this._isPlaying = false; // no need to call any other stuff
    };
    MovieClip.prototype.clone = function () {
        var clone = new MovieClip();
        if (this._adapter)
            clone.adapter = this._adapter.clone(clone);
        clone._prototype = this._prototype;
        clone._keyFrames = this._keyFrames;
        for (var i = 0; i < this._potentialChildren.length; ++i) {
            clone._potentialChildren[i] = this._potentialChildren[i].clone();
        }
        clone._fps = this._fps;
        clone._loop = this._loop;
        clone._totalFrames = this._totalFrames;
        clone._iMaskID = this._iMaskID;
        clone._iMasks = this._iMasks ? this._iMasks.concat() : null;
        clone.name = this.name;
        if (this.transform.matrix)
            clone.transform.matrix = this.transform.matrix.clone();
        clone.transform.matrix3D = this.transform.matrix3D;
        var ct = this.transform.colorTransform;
        if (ct)
            clone.transform.colorTransform = new ColorTransform(ct.redMultiplier, ct.greenMultiplier, ct.blueMultiplier, ct.alphaMultiplier, ct.redOffset, ct.greenOffset, ct.blueOffset, ct.alphaOffset);
        return clone;
    };
    MovieClip.prototype.resetPlayHead = function () {
        this._time = 0;
        this._currentFrameIndex = 0;
        for (var i = this.numChildren - 1; i >= 0; --i)
            this.removeChildAt(i);
        for (var i = 0; i < this._keyFrames.length; ++i) {
            var keyFrame = this._keyFrames[i];
            // deactivate any currently active keyframes first
            if (keyFrame.isActive)
                keyFrame.deactivate(this);
        }
    };
    MovieClip.prototype.advanceFrame = function (skipFrames) {
        if (skipFrames === void 0) { skipFrames = false; }
        var i;
        var advance = this._isPlaying;
        if (advance && this._currentFrameIndex == this._totalFrames - 1 && !this._loop) {
            advance = false;
        }
        if (advance && this._currentFrameIndex <= 0 && this._totalFrames == 1) {
            this._currentFrameIndex = 0;
            advance = false;
        }
        if (advance) {
            if (++this._currentFrameIndex == this._totalFrames)
                this.resetPlayHead();
        }
        this.updateKeyFrames(skipFrames);
        // advance children
        if (!skipFrames) {
            var len = this.numChildren;
            for (i = 0; i < len; i++) {
                var child = this.getChildAt(i);
                if (child instanceof MovieClip)
                    child.advanceFrame(skipFrames);
            }
        }
    };
    MovieClip.prototype.updateKeyFrames = function (skipFrames) {
        // TODO: Switch to frames over time (so we can check with ==, instead of > and active)
        var time = this._currentFrameIndex / this._fps * 1000;
        for (var i = 0; i < this._keyFrames.length; ++i) {
            var keyFrame = this._keyFrames[i];
            if (time >= keyFrame.startTime && time <= keyFrame.endTime && !keyFrame.isActive)
                keyFrame.activate(this);
            if (time >= keyFrame.endTime && keyFrame.isActive)
                keyFrame.deactivate(this);
            if (!skipFrames && keyFrame.isActive)
                keyFrame.update(this, this._time);
        }
    };
    // DEBUG CODE:
    MovieClip.prototype.logHierarchy = function (depth) {
        if (depth === void 0) { depth = 0; }
        this.printHierarchyName(depth, this);
        var len = this.numChildren;
        for (var i = 0; i < len; i++) {
            var child = this.getChildAt(i);
            if (child instanceof MovieClip)
                child.logHierarchy(depth + 1);
            else
                this.printHierarchyName(depth + 1, child);
        }
    };
    MovieClip.prototype.printHierarchyName = function (depth, target) {
        var str = "";
        for (var i = 0; i < depth; ++i)
            str += "--";
        str += " " + target.name;
        console.log(str);
    };
    MovieClip.assetType = "[asset MovieClip]";
    return MovieClip;
})(DisplayObjectContainer);
module.exports = MovieClip;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1wbGF5ZXIvbGliL2Rpc3BsYXkvTW92aWVDbGlwLnRzIl0sIm5hbWVzIjpbIk1vdmllQ2xpcCIsIk1vdmllQ2xpcC5jb25zdHJ1Y3RvciIsIk1vdmllQ2xpcC5hZGFwdGVyIiwiTW92aWVDbGlwLmZwcyIsIk1vdmllQ2xpcC5hc3NldFR5cGUiLCJNb3ZpZUNsaXAucGxheSIsIk1vdmllQ2xpcC51cGRhdGUiLCJNb3ZpZUNsaXAuYWRkRnJhbWUiLCJNb3ZpZUNsaXAuZ2V0UG90ZW50aWFsQ2hpbGQiLCJNb3ZpZUNsaXAucmVnaXN0ZXJQb3RlbnRpYWxDaGlsZCIsIk1vdmllQ2xpcC5hY3RpdmF0ZUNoaWxkIiwiTW92aWVDbGlwLmRlYWN0aXZhdGVDaGlsZCIsIk1vdmllQ2xpcC5leGVjdXRlRnJhbWVTY3JpcHQiLCJNb3ZpZUNsaXAuc3RvcCIsIk1vdmllQ2xpcC5jbG9uZSIsIk1vdmllQ2xpcC5yZXNldFBsYXlIZWFkIiwiTW92aWVDbGlwLmFkdmFuY2VGcmFtZSIsIk1vdmllQ2xpcC51cGRhdGVLZXlGcmFtZXMiLCJNb3ZpZUNsaXAubG9nSGllcmFyY2h5IiwiTW92aWVDbGlwLnByaW50SGllcmFyY2h5TmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxjQUFjLFdBQVcscUNBQXFDLENBQUMsQ0FBQztBQUV2RSxJQUFPLHNCQUFzQixXQUFXLHNEQUFzRCxDQUFDLENBQUM7QUFNaEcsSUFBTSxTQUFTO0lBQVNBLFVBQWxCQSxTQUFTQSxVQUErQkE7SUFrQjFDQSxTQWxCRUEsU0FBU0E7UUFvQlBDLGlCQUFPQSxDQUFDQTtRQVhKQSxVQUFLQSxHQUFXQSxJQUFJQSxDQUFDQTtRQVl6QkEsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDdkJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLElBQUlBLEtBQUtBLEVBQW9CQSxDQUFDQTtRQUNoREEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxJQUFJQSxLQUFLQSxF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QSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLE1BQU1BLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBO1lBQ3REQSxLQUFLQSxDQUFDQSxrQkFBa0JBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7UUFDckVBLENBQUNBO1FBRURBLEtBQUtBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBO1FBQ3ZCQSxLQUFLQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUN6QkEsS0FBS0EsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0E7UUFDdkNBLEtBQUtBLENBQUNBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBO1FBQy9CQSxLQUFLQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxNQUFNQSxFQUFFQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUMzREEsS0FBS0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFFdkJBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLE1BQU1BLENBQUNBO1lBQ3RCQSxLQUFLQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTtRQUUzREEsS0FBS0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0E7UUFFbkRBLElBQUlBLEVBQUVBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLGNBQWNBLENBQUNBO1FBQ3ZDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUFDQSxLQUFLQSxDQUFDQSxTQUFTQSxDQUFDQSxjQUFjQSxHQUFHQSxJQUFJQSxjQUFjQSxDQUFDQSxFQUFFQSxDQUFDQSxhQUFhQSxFQUFFQSxFQUFFQSxDQUFDQSxlQUFlQSxFQUFFQSxFQUFFQSxDQUFDQSxjQUFjQSxFQUFFQSxFQUFFQSxDQUFDQSxlQUFlQSxFQUFFQSxFQUFFQSxDQUFDQSxTQUFTQSxFQUFFQSxFQUFFQSxDQUFDQSxXQUFXQSxFQUFFQSxFQUFFQSxDQUFDQSxVQUFVQSxFQUFFQSxFQUFFQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQTtRQUV0TUEsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7SUFDakJBLENBQUNBO0lBRU9kLGlDQUFhQSxHQUFyQkE7UUFFSWUsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDZkEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUU1QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDMUNBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBRTFCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxNQUFNQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUM5Q0EsSUFBSUEsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFbENBLEFBQ0FBLGtEQURrREE7WUFDbERBLEVBQUVBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBO2dCQUNsQkEsUUFBUUEsQ0FBQ0EsVUFBVUEsQ0FBQ0Es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QUFHQSxFQUFFQSxDQUFDQTtRQUNiQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxLQUFLQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUMxQkEsR0FBR0EsSUFBSUEsSUFBSUEsQ0FBQ0E7UUFFaEJBLEdBQUdBLElBQUlBLEdBQUdBLEdBQUdBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ3pCQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUExUVVuQixtQkFBU0EsR0FBVUEsbUJBQW1CQSxDQUFDQTtJQTJRdERBLGdCQUFDQTtBQUFEQSxDQTdRQSxBQTZRQ0EsRUE3UXVCLHNCQUFzQixFQTZRN0M7QUFDRCxBQUFtQixpQkFBVixTQUFTLENBQUMiLCJmaWxlIjoiZGlzcGxheS9Nb3ZpZUNsaXAuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IENvbG9yVHJhbnNmb3JtID0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL0NvbG9yVHJhbnNmb3JtXCIpO1xyXG5pbXBvcnQgSUFzc2V0ID0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9saWJyYXJ5L0lBc3NldFwiKTtcclxuaW1wb3J0IERpc3BsYXlPYmplY3RDb250YWluZXIgPSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2NvbnRhaW5lcnMvRGlzcGxheU9iamVjdENvbnRhaW5lclwiKTtcclxuaW1wb3J0IERpc3BsYXlPYmplY3QgPSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvRGlzcGxheU9iamVjdFwiKTtcclxuXHJcbmltcG9ydCBNb3ZpZUNsaXBBZGFwdGVyID0gcmVxdWlyZShcImF3YXlqcy1wbGF5ZXIvbGliL2FkYXB0ZXJzL01vdmllQ2xpcEFkYXB0ZXJcIik7XHJcbmltcG9ydCBUaW1lbGluZUtleUZyYW1lID0gcmVxdWlyZShcImF3YXlqcy1wbGF5ZXIvbGliL3RpbWVsaW5lL1RpbWVsaW5lS2V5RnJhbWVcIik7XHJcblxyXG5jbGFzcyBNb3ZpZUNsaXAgZXh0ZW5kcyBEaXNwbGF5T2JqZWN0Q29udGFpbmVyXHJcbntcclxuXHRwdWJsaWMgc3RhdGljIGFzc2V0VHlwZTpzdHJpbmcgPSBcIlthc3NldCBNb3ZpZUNsaXBdXCI7XHJcblxyXG4gICAgcHJpdmF0ZSBfa2V5RnJhbWVzOkFycmF5PFRpbWVsaW5lS2V5RnJhbWU+O1xyXG4gICAgcHJpdmF0ZSBfdGltZTpudW1iZXI7Ly8gdGhlIGN1cnJlbnQgdGltZSBpbnNpZGUgdGhlIGFuaW1hdGlvblxyXG4gICAgcHJpdmF0ZSBfY3VycmVudEZyYW1lSW5kZXg6bnVtYmVyOy8vIHRoZSBjdXJyZW50IGZyYW1lXHJcbiAgICBwcml2YXRlIF9mcHM6bnVtYmVyOy8vIHdlIHVzZSBtcyBpbnRlcm5hbGx5LCBidXQgaGF2ZSBmcHMsIHNvIHVzZXIgY2FuIHNldCB0aW1lIGJ5IGZyYW1lXHJcbiAgICBwcml2YXRlIF9pc1BsYXlpbmc6Ym9vbGVhbjsvLyBmYWxzZSBpZiBwYXVzZWQgb3Igc3RvcHBlZFxyXG4gICAgcHJpdmF0ZSBfbG9vcDpib29sZWFuID0gdHJ1ZTtcclxuICAgIHByaXZhdGUgX3RvdGFsRnJhbWVzOm51bWJlcjtcclxuICAgIC8vIG5vdCBzdXJlIGlmIG5lZWRlZFxyXG4gICAgcHJpdmF0ZSBfcHJvdG90eXBlOk1vdmllQ2xpcDtcclxuXHJcbiAgICBwcml2YXRlIF9hZGFwdGVyOk1vdmllQ2xpcEFkYXB0ZXI7XHJcblxyXG4gICAgcHJpdmF0ZSBfcG90ZW50aWFsQ2hpbGRyZW46QXJyYXk8RGlzcGxheU9iamVjdD47XHJcblxyXG4gICAgY29uc3RydWN0b3IoKVxyXG4gICAge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5fcHJvdG90eXBlID0gdGhpcztcclxuICAgICAgICB0aGlzLl9rZXlGcmFtZXMgPSBuZXcgQXJyYXk8VGltZWxpbmVLZXlGcmFtZT4oKTtcclxuICAgICAgICB0aGlzLl9wb3RlbnRpYWxDaGlsZHJlbiA9IG5ldyBBcnJheTxEaXNwbGF5T2JqZWN0PigpO1xyXG4gICAgICAgIHRoaXMuX2N1cnJlbnRGcmFtZUluZGV4ID0gLTE7XHJcbiAgICAgICAgdGhpcy5faXNQbGF5aW5nID0gdHJ1ZTsgLy8gYXV0by1wbGF5XHJcbiAgICAgICAgdGhpcy5fZnBzID0gMjU7XHJcbiAgICAgICAgdGhpcy5fdGltZSA9IDA7XHJcbiAgICAgICAgdGhpcy5fdG90YWxGcmFtZXMgPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGFkYXB0ZXIgaXMgdXNlZCB0byBwcm92aWRlIE1vdmllQ2xpcCB0byBzY3JpcHRzIHRha2VuIGZyb20gZGlmZmVyZW50IHBsYXRmb3Jtc1xyXG4gICAgLy8gVE9ETzogUGVyaGFwcyBhZGFwdGVycyBzaG91bGQgYmUgY3JlYXRlZCBkeW5hbWljYWxseSB3aGVuZXZlciBuZWVkZWQsIHJhdGhlciB0aGFuIHN0b3JpbmcgdGhlbVxyXG4gICAgcHVibGljIGdldCBhZGFwdGVyKCk6TW92aWVDbGlwQWRhcHRlclxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9hZGFwdGVyO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHNldHRlciB0eXBpY2FsbHkgbWFuYWdlZCBieSBmYWN0b3JcclxuICAgIHB1YmxpYyBzZXQgYWRhcHRlcih2YWx1ZTpNb3ZpZUNsaXBBZGFwdGVyKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuX2FkYXB0ZXIgPSB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0IGZwcygpOm51bWJlclxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9mcHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldCBmcHMobmV3RnBzOm51bWJlcilcclxuICAgIHtcclxuICAgICAgICB0aGlzLl9mcHMgPSBuZXdGcHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldCBhc3NldFR5cGUoKTpzdHJpbmdcclxuICAgIHtcclxuICAgICAgICByZXR1cm4gTW92aWVDbGlwLmFzc2V0VHlwZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFN0YXJ0cyBwbGF5YmFjayBvZiBhbmltYXRpb24gZnJvbSBjdXJyZW50IHBvc2l0aW9uXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBwbGF5KClcclxuICAgIHtcclxuICAgICAgICB0aGlzLl9pc1BsYXlpbmcgPSB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogc2hvdWxkIGJlIGNhbGxlZCByaWdodCBiZWZvcmUgdGhlIGNhbGwgdG8gYXdheTNkLXJlbmRlci5cclxuICAgICAqL1xyXG4gICAgcHVibGljIHVwZGF0ZSh0aW1lRGVsdGE6bnVtYmVyKVxyXG4gICAge1xyXG4gICAgICAgIC8vdGhpcy5sb2dIaWVyYXJjaHkoKTtcclxuICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgcHJvcGVyIGVsYXN0aWMgcmFjZXRyYWNrIGxvZ2ljXHJcbiAgICAgICAgdmFyIGZyYW1lTWFya2VyIDogbnVtYmVyID0gMTAwMCAvIHRoaXMuX2ZwcztcclxuXHJcbiAgICAgICAgLy8gcmlnaHQgbm93LCBqdXN0IGFkdmFuY2UgZnJhbWUgb25jZSB0aW1lIG1hcmtlciBoYXMgYmVlbiByZWFjaGVkXHJcbiAgICAgICAgdGhpcy5fdGltZSArPSB0aW1lRGVsdGE7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl90aW1lID4gZnJhbWVNYXJrZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5fdGltZSA9IDA7XHJcbiAgICAgICAgICAgIHRoaXMuYWR2YW5jZUZyYW1lKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQWRkIGEgbmV3IFRpbWVsaW5lRnJhbWUuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhZGRGcmFtZShuZXdGcmFtZTpUaW1lbGluZUtleUZyYW1lKVxyXG4gICAge1xyXG4gICAgICAgIHZhciBlbmRGcmFtZSA9IE1hdGguY2VpbCgobmV3RnJhbWUuc3RhcnRUaW1lICsgbmV3RnJhbWUuZHVyYXRpb24pIC8gMTAwMCAqIHRoaXMuX2Zwcyk7XHJcbiAgICAgICAgaWYgKHRoaXMuX3RvdGFsRnJhbWVzIDwgZW5kRnJhbWUpXHJcbiAgICAgICAgICAgIHRoaXMuX3RvdGFsRnJhbWVzID0gZW5kRnJhbWU7XHJcbiAgICAgICAgdGhpcy5fa2V5RnJhbWVzLnB1c2gobmV3RnJhbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0dXJucyB0aGUgY2hpbGQgSUQgZm9yIHRoaXMgTW92aWVDbGlwXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXRQb3RlbnRpYWxDaGlsZChpZDpudW1iZXIpIDogRGlzcGxheU9iamVjdFxyXG4gICAge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wb3RlbnRpYWxDaGlsZHJlbltpZF07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXR1cm5zIHRoZSBjaGlsZCBJRCBmb3IgdGhpcyBNb3ZpZUNsaXBcclxuICAgICAqL1xyXG4gICAgcHVibGljIHJlZ2lzdGVyUG90ZW50aWFsQ2hpbGQocHJvdG90eXBlOkRpc3BsYXlPYmplY3QpIDogbnVtYmVyXHJcbiAgICB7XHJcbiAgICAgICAgdmFyIGlkID0gdGhpcy5fcG90ZW50aWFsQ2hpbGRyZW4ubGVuZ3RoO1xyXG4gICAgICAgIHRoaXMuX3BvdGVudGlhbENoaWxkcmVuW2lkXSA9IHByb3RvdHlwZS5jbG9uZSgpO1xyXG4gICAgICAgIHJldHVybiBpZDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYWN0aXZhdGVDaGlsZChpZDpudW1iZXIpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5hZGRDaGlsZCh0aGlzLl9wb3RlbnRpYWxDaGlsZHJlbltpZF0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkZWFjdGl2YXRlQ2hpbGQoaWQ6bnVtYmVyKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMucmVtb3ZlQ2hpbGQodGhpcy5fcG90ZW50aWFsQ2hpbGRyZW5baWRdKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFRoaXMgaXMgY2FsbGVkIGluc2lkZSB0aGUgVGltZWxpbmVGcmFtZS5leGVjdXRlKCkgZnVuY3Rpb24uXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgZXhlY3V0ZUZyYW1lU2NyaXB0KGZyYW1lU2NyaXB0OnN0cmluZylcclxuICAgIHtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTdG9wIHBsYXliYWNrIG9mIGFuaW1hdGlvbiBhbmQgaG9sZCBjdXJyZW50IHBvc2l0aW9uXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBzdG9wKClcclxuICAgIHtcclxuICAgICAgICB0aGlzLl9pc1BsYXlpbmcgPSBmYWxzZTsvLyBubyBuZWVkIHRvIGNhbGwgYW55IG90aGVyIHN0dWZmXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsb25lKCkgOiBEaXNwbGF5T2JqZWN0XHJcbiAgICB7XHJcbiAgICAgICAgdmFyIGNsb25lOk1vdmllQ2xpcCA9IG5ldyBNb3ZpZUNsaXAoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX2FkYXB0ZXIpIGNsb25lLmFkYXB0ZXIgPSB0aGlzLl9hZGFwdGVyLmNsb25lKGNsb25lKTtcclxuICAgICAgICBjbG9uZS5fcHJvdG90eXBlID0gdGhpcy5fcHJvdG90eXBlO1xyXG4gICAgICAgIGNsb25lLl9rZXlGcmFtZXMgPSB0aGlzLl9rZXlGcmFtZXM7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fcG90ZW50aWFsQ2hpbGRyZW4ubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgY2xvbmUuX3BvdGVudGlhbENoaWxkcmVuW2ldID0gdGhpcy5fcG90ZW50aWFsQ2hpbGRyZW5baV0uY2xvbmUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNsb25lLl9mcHMgPSB0aGlzLl9mcHM7XHJcbiAgICAgICAgY2xvbmUuX2xvb3AgPSB0aGlzLl9sb29wO1xyXG4gICAgICAgIGNsb25lLl90b3RhbEZyYW1lcyA9IHRoaXMuX3RvdGFsRnJhbWVzO1xyXG4gICAgICAgIGNsb25lLl9pTWFza0lEID0gdGhpcy5faU1hc2tJRDtcclxuICAgICAgICBjbG9uZS5faU1hc2tzID0gdGhpcy5faU1hc2tzPyB0aGlzLl9pTWFza3MuY29uY2F0KCkgOiBudWxsO1xyXG4gICAgICAgIGNsb25lLm5hbWUgPSB0aGlzLm5hbWU7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnRyYW5zZm9ybS5tYXRyaXgpXHJcbiAgICAgICAgICAgIGNsb25lLnRyYW5zZm9ybS5tYXRyaXggPSB0aGlzLnRyYW5zZm9ybS5tYXRyaXguY2xvbmUoKTtcclxuXHJcbiAgICAgICAgY2xvbmUudHJhbnNmb3JtLm1hdHJpeDNEID0gdGhpcy50cmFuc2Zvcm0ubWF0cml4M0Q7XHJcblxyXG4gICAgICAgIHZhciBjdCA9IHRoaXMudHJhbnNmb3JtLmNvbG9yVHJhbnNmb3JtO1xyXG4gICAgICAgIGlmIChjdCkgY2xvbmUudHJhbnNmb3JtLmNvbG9yVHJhbnNmb3JtID0gbmV3IENvbG9yVHJhbnNmb3JtKGN0LnJlZE11bHRpcGxpZXIsIGN0LmdyZWVuTXVsdGlwbGllciwgY3QuYmx1ZU11bHRpcGxpZXIsIGN0LmFscGhhTXVsdGlwbGllciwgY3QucmVkT2Zmc2V0LCBjdC5ncmVlbk9mZnNldCwgY3QuYmx1ZU9mZnNldCwgY3QuYWxwaGFPZmZzZXQpO1xyXG5cclxuICAgICAgICByZXR1cm4gY2xvbmU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXNldFBsYXlIZWFkKClcclxuICAgIHtcclxuICAgICAgICB0aGlzLl90aW1lID0gMDtcclxuICAgICAgICB0aGlzLl9jdXJyZW50RnJhbWVJbmRleCA9IDA7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSB0aGlzLm51bUNoaWxkcmVuIC0gMTsgaSA+PSAwOyAtLWkpXHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2hpbGRBdChpKTtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9rZXlGcmFtZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIGtleUZyYW1lID0gdGhpcy5fa2V5RnJhbWVzW2ldO1xyXG5cclxuICAgICAgICAgICAgLy8gZGVhY3RpdmF0ZSBhbnkgY3VycmVudGx5IGFjdGl2ZSBrZXlmcmFtZXMgZmlyc3RcclxuICAgICAgICAgICAgaWYgKGtleUZyYW1lLmlzQWN0aXZlKVxyXG4gICAgICAgICAgICAgICAga2V5RnJhbWUuZGVhY3RpdmF0ZSh0aGlzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhZHZhbmNlRnJhbWUoc2tpcEZyYW1lczpib29sZWFuID0gZmFsc2UpXHJcbiAgICB7XHJcbiAgICAgICAgdmFyIGk7XHJcbiAgICAgICAgdmFyIGFkdmFuY2UgPSB0aGlzLl9pc1BsYXlpbmc7XHJcbiAgICAgICAgaWYgKGFkdmFuY2UgJiYgdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPT0gdGhpcy5fdG90YWxGcmFtZXMgLSAxICYmICF0aGlzLl9sb29wKSB7XHJcbiAgICAgICAgICAgIGFkdmFuY2UgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFkdmFuY2UgJiYgdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPD0gMCAmJiB0aGlzLl90b3RhbEZyYW1lcyA9PSAxKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRGcmFtZUluZGV4ID0gMDtcclxuICAgICAgICAgICAgYWR2YW5jZSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGFkdmFuY2UpIHtcclxuICAgICAgICAgICAgaWYgKCsrdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPT0gdGhpcy5fdG90YWxGcmFtZXMpXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0UGxheUhlYWQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlS2V5RnJhbWVzKHNraXBGcmFtZXMpO1xyXG5cclxuICAgICAgICAvLyBhZHZhbmNlIGNoaWxkcmVuXHJcbiAgICAgICAgaWYgKCFza2lwRnJhbWVzKSB7XHJcbiAgICAgICAgICAgIHZhciBsZW4gPSB0aGlzLm51bUNoaWxkcmVuO1xyXG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuZ2V0Q2hpbGRBdChpKTtcclxuICAgICAgICAgICAgICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIE1vdmllQ2xpcClcclxuICAgICAgICAgICAgICAgICAgICAoPE1vdmllQ2xpcD5jaGlsZCkuYWR2YW5jZUZyYW1lKHNraXBGcmFtZXMpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBUT0RPOiBOb3Qgc3VyZSB3aGF0IGRlZmVycmVkIGNoaWxkcmVuIGFyZS4gQ2hlY2sgdy8gQ2xhdXMuXHJcbiAgICAgICAgICAgIC8qZm9yIChpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW5EZWZlcnJlZC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgaWYgKHRoaXMuY2hpbGRyZW5EZWZlcnJlZFtpXS5kaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgTW92aWVDbGlwKSB7XHJcbiAgICAgICAgICAgICAoPE1vdmllQ2xpcD50aGlzLmNoaWxkcmVuRGVmZXJyZWRbaV0uZGlzcGxheU9iamVjdCkuYWR2YW5jZUZyYW1lKGEpO1xyXG4gICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgfSovXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlS2V5RnJhbWVzKHNraXBGcmFtZXM6Ym9vbGVhbilcclxuICAgIHtcclxuICAgICAgICAvLyBUT0RPOiBTd2l0Y2ggdG8gZnJhbWVzIG92ZXIgdGltZSAoc28gd2UgY2FuIGNoZWNrIHdpdGggPT0sIGluc3RlYWQgb2YgPiBhbmQgYWN0aXZlKVxyXG5cclxuICAgICAgICB2YXIgdGltZSA9IHRoaXMuX2N1cnJlbnRGcmFtZUluZGV4IC8gdGhpcy5fZnBzICogMTAwMDtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9rZXlGcmFtZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgdmFyIGtleUZyYW1lID0gdGhpcy5fa2V5RnJhbWVzW2ldO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRpbWUgPj0ga2V5RnJhbWUuc3RhcnRUaW1lICYmIHRpbWUgPD0ga2V5RnJhbWUuZW5kVGltZSAmJiAha2V5RnJhbWUuaXNBY3RpdmUpXHJcbiAgICAgICAgICAgICAgICBrZXlGcmFtZS5hY3RpdmF0ZSh0aGlzKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aW1lID49IGtleUZyYW1lLmVuZFRpbWUgJiYga2V5RnJhbWUuaXNBY3RpdmUpXHJcbiAgICAgICAgICAgICAgICBrZXlGcmFtZS5kZWFjdGl2YXRlKHRoaXMpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFza2lwRnJhbWVzICYmIGtleUZyYW1lLmlzQWN0aXZlKVxyXG4gICAgICAgICAgICAgICAga2V5RnJhbWUudXBkYXRlKHRoaXMsIHRoaXMuX3RpbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbi8vIERFQlVHIENPREU6XHJcbiAgICBsb2dIaWVyYXJjaHkoZGVwdGg6IG51bWJlciA9IDApOnZvaWRcclxuICAgIHtcclxuICAgICAgICB0aGlzLnByaW50SGllcmFyY2h5TmFtZShkZXB0aCwgdGhpcyk7XHJcblxyXG4gICAgICAgIHZhciBsZW4gPSB0aGlzLm51bUNoaWxkcmVuO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5nZXRDaGlsZEF0KGkpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgTW92aWVDbGlwKVxyXG4gICAgICAgICAgICAgICAgKDxNb3ZpZUNsaXA+Y2hpbGQpLmxvZ0hpZXJhcmNoeShkZXB0aCArIDEpO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICB0aGlzLnByaW50SGllcmFyY2h5TmFtZShkZXB0aCArIDEsIGNoaWxkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpbnRIaWVyYXJjaHlOYW1lKGRlcHRoOm51bWJlciwgdGFyZ2V0OkRpc3BsYXlPYmplY3QpXHJcbiAgICB7XHJcbiAgICAgICAgdmFyIHN0ciA9IFwiXCI7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZXB0aDsgKytpKVxyXG4gICAgICAgICAgICBzdHIgKz0gXCItLVwiO1xyXG5cclxuICAgICAgICBzdHIgKz0gXCIgXCIgKyB0YXJnZXQubmFtZTtcclxuICAgICAgICBjb25zb2xlLmxvZyhzdHIpO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydCA9IE1vdmllQ2xpcDtcclxuIl19