var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var ColorTransform = require("awayjs-core/lib/geom/ColorTransform");
var AssetType = require("awayjs-core/lib/library/AssetType");
var DisplayObjectContainer = require("awayjs-display/lib/containers/DisplayObjectContainer");
var MovieClip = (function (_super) {
    __extends(MovieClip, _super);
    function MovieClip() {
        _super.call(this);
        this._loop = true;
        this._prototype = this;
        this._keyFrames = new Array();
        this._potentialChildren = new Array();
        this._currentFrameIndex = -1;
        this._isPlaying = true; // auto-play
        this._fps = 25;
        this._time = 0;
        this._totalFrames = 0;
    }
    Object.defineProperty(MovieClip.prototype, "adapter", {
        // adapter is used to provide MovieClip to scripts taken from different platforms
        // TODO: Perhaps adapters should be created dynamically whenever needed, rather than storing them
        get: function () {
            return this._adapter;
        },
        // setter typically managed by factor
        set: function (value) {
            this._adapter = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MovieClip.prototype, "fps", {
        get: function () {
            return this._fps;
        },
        set: function (newFps) {
            this._fps = newFps;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MovieClip.prototype, "assetType", {
        get: function () {
            return AssetType.TIMELINE;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Starts playback of animation from current position
     */
    MovieClip.prototype.play = function () {
        this._isPlaying = true;
    };
    /**
     * should be called right before the call to away3d-render.
     */
    MovieClip.prototype.update = function (timeDelta) {
        //this.logHierarchy();
        // TODO: Implement proper elastic racetrack logic
        var frameMarker = 1000 / this._fps;
        // right now, just advance frame once time marker has been reached
        this._time += timeDelta;
        if (this._time > frameMarker) {
            this._time = 0;
            this.advanceFrame();
        }
    };
    /**
     * Add a new TimelineFrame.
     */
    MovieClip.prototype.addFrame = function (newFrame) {
        var endFrame = Math.ceil((newFrame.startTime + newFrame.duration) / 1000 * this._fps);
        if (this._totalFrames < endFrame)
            this._totalFrames = endFrame;
        this._keyFrames.push(newFrame);
    };
    /**
     * Returns the child ID for this MovieClip
     */
    MovieClip.prototype.getPotentialChild = function (id) {
        return this._potentialChildren[id];
    };
    /**
     * Returns the child ID for this MovieClip
     */
    MovieClip.prototype.registerPotentialChild = function (prototype) {
        var id = this._potentialChildren.length;
        this._potentialChildren[id] = prototype.clone();
        return id;
    };
    MovieClip.prototype.activateChild = function (id) {
        this.addChild(this._potentialChildren[id]);
    };
    MovieClip.prototype.deactivateChild = function (id) {
        this.removeChild(this._potentialChildren[id]);
    };
    /**
     * This is called inside the TimelineFrame.execute() function.
     */
    MovieClip.prototype.executeFrameScript = function (frameScript) {
    };
    /**
     * Stop playback of animation and hold current position
     */
    MovieClip.prototype.stop = function () {
        this._isPlaying = false; // no need to call any other stuff
    };
    MovieClip.prototype.clone = function () {
        var clone = new MovieClip();
        if (this._adapter)
            clone.adapter = this._adapter.clone(clone);
        clone._prototype = this._prototype;
        clone._keyFrames = this._keyFrames;
        for (var i = 0; i < this._potentialChildren.length; ++i) {
            clone._potentialChildren[i] = this._potentialChildren[i].clone();
        }
        clone._fps = this._fps;
        clone._loop = this._loop;
        clone._totalFrames = this._totalFrames;
        clone.name = this.name;
        if (this.transform.matrix)
            clone.transform.matrix = this.transform.matrix.clone();
        clone.transform.matrix3D = this.transform.matrix3D;
        var ct = this.transform.colorTransform;
        if (ct)
            clone.transform.colorTransform = new ColorTransform(ct.redMultiplier, ct.greenMultiplier, ct.blueMultiplier, ct.alphaMultiplier, ct.redOffset, ct.greenOffset, ct.blueOffset, ct.alphaOffset);
        return clone;
    };
    MovieClip.prototype.resetPlayHead = function () {
        this._time = 0;
        this._currentFrameIndex = 0;
        for (var i = this.numChildren - 1; i >= 0; --i)
            this.removeChildAt(i);
        for (var i = 0; i < this._keyFrames.length; ++i) {
            var keyFrame = this._keyFrames[i];
            // deactivate any currently active keyframes first
            if (keyFrame.isActive)
                keyFrame.deactivate(this);
        }
    };
    MovieClip.prototype.advanceFrame = function (skipFrames) {
        if (skipFrames === void 0) { skipFrames = false; }
        var i;
        var advance = this._isPlaying;
        if (advance && this._currentFrameIndex == this._totalFrames - 1 && !this._loop) {
            advance = false;
        }
        if (advance && this._currentFrameIndex <= 0 && this._totalFrames == 1) {
            this._currentFrameIndex = 0;
            advance = false;
        }
        if (advance) {
            if (++this._currentFrameIndex == this._totalFrames)
                this.resetPlayHead();
        }
        this.updateKeyFrames(skipFrames);
        // advance children
        if (!skipFrames) {
            var len = this.numChildren;
            for (i = 0; i < len; i++) {
                var child = this.getChildAt(i);
                if (child instanceof MovieClip)
                    child.advanceFrame(skipFrames);
            }
        }
    };
    MovieClip.prototype.updateKeyFrames = function (skipFrames) {
        // TODO: Switch to frames over time (so we can check with ==, instead of > and active)
        var time = this._currentFrameIndex / this._fps * 1000;
        for (var i = 0; i < this._keyFrames.length; ++i) {
            var keyFrame = this._keyFrames[i];
            if (time >= keyFrame.startTime && time <= keyFrame.endTime && !keyFrame.isActive)
                keyFrame.activate(this);
            if (time >= keyFrame.endTime && keyFrame.isActive)
                keyFrame.deactivate(this);
            if (!skipFrames && keyFrame.isActive)
                keyFrame.update(this, this._time);
        }
    };
    // DEBUG CODE:
    MovieClip.prototype.logHierarchy = function (depth) {
        if (depth === void 0) { depth = 0; }
        this.printHierarchyName(depth, this);
        var len = this.numChildren;
        for (var i = 0; i < len; i++) {
            var child = this.getChildAt(i);
            if (child instanceof MovieClip)
                child.logHierarchy(depth + 1);
            else
                this.printHierarchyName(depth + 1, child);
        }
    };
    MovieClip.prototype.printHierarchyName = function (depth, target) {
        var str = "";
        for (var i = 0; i < depth; ++i)
            str += "--";
        str += " " + target.name;
        console.log(str);
    };
    return MovieClip;
})(DisplayObjectContainer);
module.exports = MovieClip;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1wbGF5ZXIvbGliL2Rpc3BsYXkvTW92aWVDbGlwLnRzIl0sIm5hbWVzIjpbIk1vdmllQ2xpcCIsIk1vdmllQ2xpcC5jb25zdHJ1Y3RvciIsIk1vdmllQ2xpcC5hZGFwdGVyIiwiTW92aWVDbGlwLmZwcyIsIk1vdmllQ2xpcC5hc3NldFR5cGUiLCJNb3ZpZUNsaXAucGxheSIsIk1vdmllQ2xpcC51cGRhdGUiLCJNb3ZpZUNsaXAuYWRkRnJhbWUiLCJNb3ZpZUNsaXAuZ2V0UG90ZW50aWFsQ2hpbGQiLCJNb3ZpZUNsaXAucmVnaXN0ZXJQb3RlbnRpYWxDaGlsZCIsIk1vdmllQ2xpcC5hY3RpdmF0ZUNoaWxkIiwiTW92aWVDbGlwLmRlYWN0aXZhdGVDaGlsZCIsIk1vdmllQ2xpcC5leGVjdXRlRnJhbWVTY3JpcHQiLCJNb3ZpZUNsaXAuc3RvcCIsIk1vdmllQ2xpcC5jbG9uZSIsIk1vdmllQ2xpcC5yZXNldFBsYXlIZWFkIiwiTW92aWVDbGlwLmFkdmFuY2VGcmFtZSIsIk1vdmllQ2xpcC51cGRhdGVLZXlGcmFtZXMiLCJNb3ZpZUNsaXAubG9nSGllcmFyY2h5IiwiTW92aWVDbGlwLnByaW50SGllcmFyY2h5TmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxjQUFjLFdBQVcscUNBQXFDLENBQUMsQ0FBQztBQUV2RSxJQUFPLFNBQVMsV0FBVyxtQ0FBbUMsQ0FBQyxDQUFDO0FBQ2hFLElBQU8sc0JBQXNCLFdBQVcsc0RBQXNELENBQUMsQ0FBQztBQU1oRyxJQUFNLFNBQVM7SUFBU0EsVUFBbEJBLFNBQVNBLFVBQStCQTtJQWdCMUNBLFNBaEJFQSxTQUFTQTtRQWtCUEMsaUJBQU9BLENBQUNBO1FBWEpBLFVBQUtBLEdBQVdBLElBQUlBLENBQUNBO1FBWXpCQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUN2QkEsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsSUFBSUEsS0FBS0EsRUFBb0JBLENBQUNBO1FBQ2hEQSxJ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QUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsTUFBTUEsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0E7WUFDdERBLEtBQUtBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTtRQUNyRUEsQ0FBQ0E7UUFFREEsS0FBS0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDdkJBLEtBQUtBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBO1FBQ3pCQSxLQUFLQSxDQUFDQSxZQUFZQSxHQUFHQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQTtRQUN2Q0EsS0FBS0EsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFFdkJBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLE1BQU1BLENBQUNBO1lBQ3RCQSxLQUFLQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTtRQUUzREEsS0FBS0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0E7UUFFbkRBLElBQUlBLEVBQUVBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLGNBQWNBLENBQUNBO1FBQ3ZDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUFDQSxLQUFLQSxDQUFDQSxTQUFTQSxDQUFDQSxjQUFjQSxHQUFHQSxJQUFJQSxjQUFjQSxDQUFDQSxFQUFFQSxDQUFDQSxhQUFhQSxFQUFFQSxFQUFFQSxDQUFDQSxlQUFlQSxFQUFF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QkFDdkJBLElBQUlBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUMvQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsWUFBWUEsU0FBU0EsQ0FBQ0E7b0JBQ2ZBLEtBQU1BLENBQUNBLFlBQVlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1lBQ3BEQSxDQUFDQTtRQVFMQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVPaEIsbUNBQWVBLEdBQXZCQSxVQUF3QkEsVUFBa0JBO1FBRXRDaUIsc0ZBQXNGQTtRQUV0RkEsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUV0REEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsTUFBTUEsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0E7WUFDOUNBLElBQUlBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBRWxDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxJQUFJQSxRQUFRQSxDQUFDQSxTQUFTQSxJQUFJQSxJQUFJQSxJQUFJQSxRQUFRQSxDQUFDQSxPQUFPQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxRQUFRQSxDQUFDQTtnQkFDN0VBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBRTVCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxJQUFJQSxRQUFRQSxDQUFDQSxPQUFPQSxJQUFJQSxRQUFRQSxDQUFDQSxRQUFRQSxDQUFDQTtnQkFDOUNBLFFBQVFBLENBQUNBLFVBQVVBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBRTlCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxVQUFVQSxJQUFJQSxRQUFRQSxDQUFDQSxRQUFRQSxDQUFDQTtnQkFDakNBLFFBQVFBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLEVBQUVBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBQzFDQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVMakIsY0FBY0E7SUFDVkEsZ0NBQVlBLEdBQVpBLFVBQWFBLEtBQWlCQTtRQUFqQmtCLHFCQUFpQkEsR0FBakJBLFNBQWlCQTtRQUUxQkEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUVyQ0EsSUFBSUEsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0E7UUFDM0JBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEdBQUdBLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQzNCQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUUvQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsWUFBWUEsU0FBU0EsQ0FBQ0E7Z0JBQ2ZBLEtBQU1BLENBQUNBLFlBQVlBLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1lBQy9DQSxJQUFJQTtnQkFDQUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUNsREEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFRGxCLHNDQUFrQkEsR0FBbEJBLFVBQW1CQSxLQUFZQSxFQUFFQSxNQUFvQkE7UUFFakRtQixJQUFJQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUNiQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxLQUFLQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUMxQkEsR0FBR0EsSUFBSUEsSUFBSUEsQ0FBQ0E7UUFFaEJBLEdBQUdBLElBQUlBLEdBQUdBLEdBQUdBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ3pCQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUFDTG5CLGdCQUFDQTtBQUFEQSxDQXpRQSxBQXlRQ0EsRUF6UXVCLHNCQUFzQixFQXlRN0M7QUFDRCxBQUFtQixpQkFBVixTQUFTLENBQUMiLCJmaWxlIjoiZGlzcGxheS9Nb3ZpZUNsaXAuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IENvbG9yVHJhbnNmb3JtID0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL0NvbG9yVHJhbnNmb3JtXCIpO1xyXG5pbXBvcnQgSUFzc2V0ID0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9saWJyYXJ5L0lBc3NldFwiKTtcclxuaW1wb3J0IEFzc2V0VHlwZSA9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvbGlicmFyeS9Bc3NldFR5cGVcIik7XHJcbmltcG9ydCBEaXNwbGF5T2JqZWN0Q29udGFpbmVyID0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9jb250YWluZXJzL0Rpc3BsYXlPYmplY3RDb250YWluZXJcIik7XHJcbmltcG9ydCBEaXNwbGF5T2JqZWN0ID0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9iYXNlL0Rpc3BsYXlPYmplY3RcIik7XHJcblxyXG5pbXBvcnQgTW92aWVDbGlwQWRhcHRlciA9IHJlcXVpcmUoXCJhd2F5anMtcGxheWVyL2xpYi9hZGFwdGVycy9Nb3ZpZUNsaXBBZGFwdGVyXCIpO1xyXG5pbXBvcnQgVGltZWxpbmVLZXlGcmFtZSA9IHJlcXVpcmUoXCJhd2F5anMtcGxheWVyL2xpYi90aW1lbGluZS9UaW1lbGluZUtleUZyYW1lXCIpO1xyXG5cclxuY2xhc3MgTW92aWVDbGlwIGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lclxyXG57XHJcbiAgICBwcml2YXRlIF9rZXlGcmFtZXM6QXJyYXk8VGltZWxpbmVLZXlGcmFtZT47XHJcbiAgICBwcml2YXRlIF90aW1lOm51bWJlcjsvLyB0aGUgY3VycmVudCB0aW1lIGluc2lkZSB0aGUgYW5pbWF0aW9uXHJcbiAgICBwcml2YXRlIF9jdXJyZW50RnJhbWVJbmRleDpudW1iZXI7Ly8gdGhlIGN1cnJlbnQgZnJhbWVcclxuICAgIHByaXZhdGUgX2ZwczpudW1iZXI7Ly8gd2UgdXNlIG1zIGludGVybmFsbHksIGJ1dCBoYXZlIGZwcywgc28gdXNlciBjYW4gc2V0IHRpbWUgYnkgZnJhbWVcclxuICAgIHByaXZhdGUgX2lzUGxheWluZzpib29sZWFuOy8vIGZhbHNlIGlmIHBhdXNlZCBvciBzdG9wcGVkXHJcbiAgICBwcml2YXRlIF9sb29wOmJvb2xlYW4gPSB0cnVlO1xyXG4gICAgcHJpdmF0ZSBfdG90YWxGcmFtZXM6bnVtYmVyO1xyXG4gICAgLy8gbm90IHN1cmUgaWYgbmVlZGVkXHJcbiAgICBwcml2YXRlIF9wcm90b3R5cGU6TW92aWVDbGlwO1xyXG5cclxuICAgIHByaXZhdGUgX2FkYXB0ZXI6TW92aWVDbGlwQWRhcHRlcjtcclxuXHJcbiAgICBwcml2YXRlIF9wb3RlbnRpYWxDaGlsZHJlbjpBcnJheTxEaXNwbGF5T2JqZWN0PjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpXHJcbiAgICB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLl9wcm90b3R5cGUgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMuX2tleUZyYW1lcyA9IG5ldyBBcnJheTxUaW1lbGluZUtleUZyYW1lPigpO1xyXG4gICAgICAgIHRoaXMuX3BvdGVudGlhbENoaWxkcmVuID0gbmV3IEFycmF5PERpc3BsYXlPYmplY3Q+KCk7XHJcbiAgICAgICAgdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPSAtMTtcclxuICAgICAgICB0aGlzLl9pc1BsYXlpbmcgPSB0cnVlOyAvLyBhdXRvLXBsYXlcclxuICAgICAgICB0aGlzLl9mcHMgPSAyNTtcclxuICAgICAgICB0aGlzLl90aW1lID0gMDtcclxuICAgICAgICB0aGlzLl90b3RhbEZyYW1lcyA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gYWRhcHRlciBpcyB1c2VkIHRvIHByb3ZpZGUgTW92aWVDbGlwIHRvIHNjcmlwdHMgdGFrZW4gZnJvbSBkaWZmZXJlbnQgcGxhdGZvcm1zXHJcbiAgICAvLyBUT0RPOiBQZXJoYXBzIGFkYXB0ZXJzIHNob3VsZCBiZSBjcmVhdGVkIGR5bmFtaWNhbGx5IHdoZW5ldmVyIG5lZWRlZCwgcmF0aGVyIHRoYW4gc3RvcmluZyB0aGVtXHJcbiAgICBwdWJsaWMgZ2V0IGFkYXB0ZXIoKTpNb3ZpZUNsaXBBZGFwdGVyXHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FkYXB0ZXI7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc2V0dGVyIHR5cGljYWxseSBtYW5hZ2VkIGJ5IGZhY3RvclxyXG4gICAgcHVibGljIHNldCBhZGFwdGVyKHZhbHVlOk1vdmllQ2xpcEFkYXB0ZXIpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5fYWRhcHRlciA9IHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXQgZnBzKCk6bnVtYmVyXHJcbiAgICB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZwcztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2V0IGZwcyhuZXdGcHM6bnVtYmVyKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuX2ZwcyA9IG5ld0ZwcztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0IGFzc2V0VHlwZSgpOnN0cmluZ1xyXG4gICAge1xyXG4gICAgICAgIHJldHVybiBBc3NldFR5cGUuVElNRUxJTkU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTdGFydHMgcGxheWJhY2sgb2YgYW5pbWF0aW9uIGZyb20gY3VycmVudCBwb3NpdGlvblxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcGxheSgpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5faXNQbGF5aW5nID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIHNob3VsZCBiZSBjYWxsZWQgcmlnaHQgYmVmb3JlIHRoZSBjYWxsIHRvIGF3YXkzZC1yZW5kZXIuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyB1cGRhdGUodGltZURlbHRhOm51bWJlcilcclxuICAgIHtcclxuICAgICAgICAvL3RoaXMubG9nSGllcmFyY2h5KCk7XHJcbiAgICAgICAgLy8gVE9ETzogSW1wbGVtZW50IHByb3BlciBlbGFzdGljIHJhY2V0cmFjayBsb2dpY1xyXG4gICAgICAgIHZhciBmcmFtZU1hcmtlciA6IG51bWJlciA9IDEwMDAgLyB0aGlzLl9mcHM7XHJcblxyXG4gICAgICAgIC8vIHJpZ2h0IG5vdywganVzdCBhZHZhbmNlIGZyYW1lIG9uY2UgdGltZSBtYXJrZXIgaGFzIGJlZW4gcmVhY2hlZFxyXG4gICAgICAgIHRoaXMuX3RpbWUgKz0gdGltZURlbHRhO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5fdGltZSA+IGZyYW1lTWFya2VyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3RpbWUgPSAwO1xyXG4gICAgICAgICAgICB0aGlzLmFkdmFuY2VGcmFtZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEFkZCBhIG5ldyBUaW1lbGluZUZyYW1lLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgYWRkRnJhbWUobmV3RnJhbWU6VGltZWxpbmVLZXlGcmFtZSlcclxuICAgIHtcclxuICAgICAgICB2YXIgZW5kRnJhbWUgPSBNYXRoLmNlaWwoKG5ld0ZyYW1lLnN0YXJ0VGltZSArIG5ld0ZyYW1lLmR1cmF0aW9uKSAvIDEwMDAgKiB0aGlzLl9mcHMpO1xyXG4gICAgICAgIGlmICh0aGlzLl90b3RhbEZyYW1lcyA8IGVuZEZyYW1lKVxyXG4gICAgICAgICAgICB0aGlzLl90b3RhbEZyYW1lcyA9IGVuZEZyYW1lO1xyXG4gICAgICAgIHRoaXMuX2tleUZyYW1lcy5wdXNoKG5ld0ZyYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJldHVybnMgdGhlIGNoaWxkIElEIGZvciB0aGlzIE1vdmllQ2xpcFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZ2V0UG90ZW50aWFsQ2hpbGQoaWQ6bnVtYmVyKSA6IERpc3BsYXlPYmplY3RcclxuICAgIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcG90ZW50aWFsQ2hpbGRyZW5baWRdO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0dXJucyB0aGUgY2hpbGQgSUQgZm9yIHRoaXMgTW92aWVDbGlwXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyByZWdpc3RlclBvdGVudGlhbENoaWxkKHByb3RvdHlwZTpEaXNwbGF5T2JqZWN0KSA6IG51bWJlclxyXG4gICAge1xyXG4gICAgICAgIHZhciBpZCA9IHRoaXMuX3BvdGVudGlhbENoaWxkcmVuLmxlbmd0aDtcclxuICAgICAgICB0aGlzLl9wb3RlbnRpYWxDaGlsZHJlbltpZF0gPSBwcm90b3R5cGUuY2xvbmUoKTtcclxuICAgICAgICByZXR1cm4gaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFjdGl2YXRlQ2hpbGQoaWQ6bnVtYmVyKVxyXG4gICAge1xyXG4gICAgICAgIHRoaXMuYWRkQ2hpbGQodGhpcy5fcG90ZW50aWFsQ2hpbGRyZW5baWRdKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZGVhY3RpdmF0ZUNoaWxkKGlkOm51bWJlcilcclxuICAgIHtcclxuICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX3BvdGVudGlhbENoaWxkcmVuW2lkXSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUaGlzIGlzIGNhbGxlZCBpbnNpZGUgdGhlIFRpbWVsaW5lRnJhbWUuZXhlY3V0ZSgpIGZ1bmN0aW9uLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGV4ZWN1dGVGcmFtZVNjcmlwdChmcmFtZVNjcmlwdDpzdHJpbmcpXHJcbiAgICB7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogU3RvcCBwbGF5YmFjayBvZiBhbmltYXRpb24gYW5kIGhvbGQgY3VycmVudCBwb3NpdGlvblxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc3RvcCgpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5faXNQbGF5aW5nID0gZmFsc2U7Ly8gbm8gbmVlZCB0byBjYWxsIGFueSBvdGhlciBzdHVmZlxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbG9uZSgpIDogRGlzcGxheU9iamVjdFxyXG4gICAge1xyXG4gICAgICAgIHZhciBjbG9uZTpNb3ZpZUNsaXAgPSBuZXcgTW92aWVDbGlwKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLl9hZGFwdGVyKSBjbG9uZS5hZGFwdGVyID0gdGhpcy5fYWRhcHRlci5jbG9uZShjbG9uZSk7XHJcbiAgICAgICAgY2xvbmUuX3Byb3RvdHlwZSA9IHRoaXMuX3Byb3RvdHlwZTtcclxuICAgICAgICBjbG9uZS5fa2V5RnJhbWVzID0gdGhpcy5fa2V5RnJhbWVzO1xyXG5cclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3BvdGVudGlhbENoaWxkcmVuLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGNsb25lLl9wb3RlbnRpYWxDaGlsZHJlbltpXSA9IHRoaXMuX3BvdGVudGlhbENoaWxkcmVuW2ldLmNsb25lKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjbG9uZS5fZnBzID0gdGhpcy5fZnBzO1xyXG4gICAgICAgIGNsb25lLl9sb29wID0gdGhpcy5fbG9vcDtcclxuICAgICAgICBjbG9uZS5fdG90YWxGcmFtZXMgPSB0aGlzLl90b3RhbEZyYW1lcztcclxuICAgICAgICBjbG9uZS5uYW1lID0gdGhpcy5uYW1lO1xyXG5cclxuICAgICAgICBpZiAodGhpcy50cmFuc2Zvcm0ubWF0cml4KVxyXG4gICAgICAgICAgICBjbG9uZS50cmFuc2Zvcm0ubWF0cml4ID0gdGhpcy50cmFuc2Zvcm0ubWF0cml4LmNsb25lKCk7XHJcblxyXG4gICAgICAgIGNsb25lLnRyYW5zZm9ybS5tYXRyaXgzRCA9IHRoaXMudHJhbnNmb3JtLm1hdHJpeDNEO1xyXG5cclxuICAgICAgICB2YXIgY3QgPSB0aGlzLnRyYW5zZm9ybS5jb2xvclRyYW5zZm9ybTtcclxuICAgICAgICBpZiAoY3QpIGNsb25lLnRyYW5zZm9ybS5jb2xvclRyYW5zZm9ybSA9IG5ldyBDb2xvclRyYW5zZm9ybShjdC5yZWRNdWx0aXBsaWVyLCBjdC5ncmVlbk11bHRpcGxpZXIsIGN0LmJsdWVNdWx0aXBsaWVyLCBjdC5hbHBoYU11bHRpcGxpZXIsIGN0LnJlZE9mZnNldCwgY3QuZ3JlZW5PZmZzZXQsIGN0LmJsdWVPZmZzZXQsIGN0LmFscGhhT2Zmc2V0KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGNsb25lO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVzZXRQbGF5SGVhZCgpXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5fdGltZSA9IDA7XHJcbiAgICAgICAgdGhpcy5fY3VycmVudEZyYW1lSW5kZXggPSAwO1xyXG5cclxuICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5udW1DaGlsZHJlbiAtIDE7IGkgPj0gMDsgLS1pKVxyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkQXQoaSk7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fa2V5RnJhbWVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciBrZXlGcmFtZSA9IHRoaXMuX2tleUZyYW1lc1tpXTtcclxuXHJcbiAgICAgICAgICAgIC8vIGRlYWN0aXZhdGUgYW55IGN1cnJlbnRseSBhY3RpdmUga2V5ZnJhbWVzIGZpcnN0XHJcbiAgICAgICAgICAgIGlmIChrZXlGcmFtZS5pc0FjdGl2ZSlcclxuICAgICAgICAgICAgICAgIGtleUZyYW1lLmRlYWN0aXZhdGUodGhpcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWR2YW5jZUZyYW1lKHNraXBGcmFtZXM6Ym9vbGVhbiA9IGZhbHNlKVxyXG4gICAge1xyXG4gICAgICAgIHZhciBpO1xyXG4gICAgICAgIHZhciBhZHZhbmNlID0gdGhpcy5faXNQbGF5aW5nO1xyXG4gICAgICAgIGlmIChhZHZhbmNlICYmIHRoaXMuX2N1cnJlbnRGcmFtZUluZGV4ID09IHRoaXMuX3RvdGFsRnJhbWVzIC0gMSAmJiAhdGhpcy5fbG9vcCkge1xyXG4gICAgICAgICAgICBhZHZhbmNlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhZHZhbmNlICYmIHRoaXMuX2N1cnJlbnRGcmFtZUluZGV4IDw9IDAgJiYgdGhpcy5fdG90YWxGcmFtZXMgPT0gMSkge1xyXG4gICAgICAgICAgICB0aGlzLl9jdXJyZW50RnJhbWVJbmRleCA9IDA7XHJcbiAgICAgICAgICAgIGFkdmFuY2UgPSBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChhZHZhbmNlKSB7XHJcbiAgICAgICAgICAgIGlmICgrK3RoaXMuX2N1cnJlbnRGcmFtZUluZGV4ID09IHRoaXMuX3RvdGFsRnJhbWVzKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXNldFBsYXlIZWFkKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnVwZGF0ZUtleUZyYW1lcyhza2lwRnJhbWVzKTtcclxuXHJcbiAgICAgICAgLy8gYWR2YW5jZSBjaGlsZHJlblxyXG4gICAgICAgIGlmICghc2tpcEZyYW1lcykge1xyXG4gICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5udW1DaGlsZHJlbjtcclxuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLmdldENoaWxkQXQoaSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgaW5zdGFuY2VvZiBNb3ZpZUNsaXApXHJcbiAgICAgICAgICAgICAgICAgICAgKDxNb3ZpZUNsaXA+Y2hpbGQpLmFkdmFuY2VGcmFtZShza2lwRnJhbWVzKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gVE9ETzogTm90IHN1cmUgd2hhdCBkZWZlcnJlZCBjaGlsZHJlbiBhcmUuIENoZWNrIHcvIENsYXVzLlxyXG4gICAgICAgICAgICAvKmZvciAoaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuRGVmZXJyZWQubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgIGlmICh0aGlzLmNoaWxkcmVuRGVmZXJyZWRbaV0uZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIE1vdmllQ2xpcCkge1xyXG4gICAgICAgICAgICAgKDxNb3ZpZUNsaXA+dGhpcy5jaGlsZHJlbkRlZmVycmVkW2ldLmRpc3BsYXlPYmplY3QpLmFkdmFuY2VGcmFtZShhKTtcclxuICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgIH0qL1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHVwZGF0ZUtleUZyYW1lcyhza2lwRnJhbWVzOmJvb2xlYW4pXHJcbiAgICB7XHJcbiAgICAgICAgLy8gVE9ETzogU3dpdGNoIHRvIGZyYW1lcyBvdmVyIHRpbWUgKHNvIHdlIGNhbiBjaGVjayB3aXRoID09LCBpbnN0ZWFkIG9mID4gYW5kIGFjdGl2ZSlcclxuXHJcbiAgICAgICAgdmFyIHRpbWUgPSB0aGlzLl9jdXJyZW50RnJhbWVJbmRleCAvIHRoaXMuX2ZwcyAqIDEwMDA7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fa2V5RnJhbWVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIHZhciBrZXlGcmFtZSA9IHRoaXMuX2tleUZyYW1lc1tpXTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aW1lID49IGtleUZyYW1lLnN0YXJ0VGltZSAmJiB0aW1lIDw9IGtleUZyYW1lLmVuZFRpbWUgJiYgIWtleUZyYW1lLmlzQWN0aXZlKVxyXG4gICAgICAgICAgICAgICAga2V5RnJhbWUuYWN0aXZhdGUodGhpcyk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGltZSA+PSBrZXlGcmFtZS5lbmRUaW1lICYmIGtleUZyYW1lLmlzQWN0aXZlKVxyXG4gICAgICAgICAgICAgICAga2V5RnJhbWUuZGVhY3RpdmF0ZSh0aGlzKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghc2tpcEZyYW1lcyAmJiBrZXlGcmFtZS5pc0FjdGl2ZSlcclxuICAgICAgICAgICAgICAgIGtleUZyYW1lLnVwZGF0ZSh0aGlzLCB0aGlzLl90aW1lKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4vLyBERUJVRyBDT0RFOlxyXG4gICAgbG9nSGllcmFyY2h5KGRlcHRoOiBudW1iZXIgPSAwKTp2b2lkXHJcbiAgICB7XHJcbiAgICAgICAgdGhpcy5wcmludEhpZXJhcmNoeU5hbWUoZGVwdGgsIHRoaXMpO1xyXG5cclxuICAgICAgICB2YXIgbGVuID0gdGhpcy5udW1DaGlsZHJlbjtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMuZ2V0Q2hpbGRBdChpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChjaGlsZCBpbnN0YW5jZW9mIE1vdmllQ2xpcClcclxuICAgICAgICAgICAgICAgICg8TW92aWVDbGlwPmNoaWxkKS5sb2dIaWVyYXJjaHkoZGVwdGggKyAxKTtcclxuICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgdGhpcy5wcmludEhpZXJhcmNoeU5hbWUoZGVwdGggKyAxLCBjaGlsZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaW50SGllcmFyY2h5TmFtZShkZXB0aDpudW1iZXIsIHRhcmdldDpEaXNwbGF5T2JqZWN0KVxyXG4gICAge1xyXG4gICAgICAgIHZhciBzdHIgPSBcIlwiO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVwdGg7ICsraSlcclxuICAgICAgICAgICAgc3RyICs9IFwiLS1cIjtcclxuXHJcbiAgICAgICAgc3RyICs9IFwiIFwiICsgdGFyZ2V0Lm5hbWU7XHJcbiAgICAgICAgY29uc29sZS5sb2coc3RyKTtcclxuICAgIH1cclxufVxyXG5leHBvcnQgPSBNb3ZpZUNsaXA7XHJcbiJdfQ==