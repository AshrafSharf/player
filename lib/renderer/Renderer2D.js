var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var DefaultMaterialManager = require("awayjs-display/lib/managers/DefaultMaterialManager");
var DefaultRenderer = require("awayjs-renderergl/lib/DefaultRenderer");
var Mask = require("awayjs-player/lib/renderer/Mask");
var RenderableSort2D = require("awayjs-player/lib/renderer/RenderableSort2D");
var Renderer2D = (function (_super) {
    __extends(Renderer2D, _super);
    function Renderer2D(rendererPoolClass, stage) {
        if (rendererPoolClass === void 0) { rendererPoolClass = null; }
        if (stage === void 0) { stage = null; }
        _super.call(this, rendererPoolClass, stage);
        this.renderableSorter = new RenderableSort2D();
        this._mask = new Mask(this._pStage, this);
    }
    Renderer2D.prototype.drawRenderables = function (renderable, entityCollector) {
        var i;
        var len;
        var renderable2;
        var renderObject;
        var passes;
        var pass;
        var camera = entityCollector.camera;
        var maskConfigID = -1;
        /*// TypeScript does not allow calling super.setters -_-
        //this._mask.width = this._pRttBufferManager.textureWidth;
        //this._mask.height = this._pRttBufferManager.textureHeight;*/
        this._mask.reset();
        this._pContext.setStencilActions("frontAndBack", "always", "keep", "keep", "keep");
        //console.log("------");
        var gl = this._pContext["_gl"];
        var gl = this._pContext["_gl"];
        gl.disable(gl.STENCIL_TEST);
        while (renderable) {
            renderObject = renderable.renderObject;
            passes = renderObject.passes;
            if (renderable.sourceEntity["hierarchicalMaskID"] !== -1) {
                renderable2 = renderable.next;
                //console.log("Registering mask: " + renderable.sourceEntity["hierarchicalMaskID"]);
                this._mask.registerMask(renderable);
            }
            else if (this._disableColor && renderObject._renderObjectOwner.alphaThreshold != 0) {
                renderable2 = renderable;
                do {
                    renderable2 = renderable2.next;
                } while (renderable2 && renderable2.renderObject == renderObject);
            }
            else {
                var newMaskConfigID = renderable.sourceEntity["maskConfigID"];
                if (maskConfigID !== newMaskConfigID) {
                    if (newMaskConfigID === -1) {
                        // disable stencil
                        //this._pContext.setStencilActions("frontAndBack", "always", "keep", "keep", "keep");
                        gl.disable(gl.STENCIL_TEST);
                        gl.stencilFunc(gl.ALWAYS, 0, 0xff);
                        gl.stencilOp(gl.KEEP, gl.KEEP, gl.KEEP);
                    }
                    else {
                        //console.log("Rendering masks with configID " + newMaskConfigID);
                        //this._pContext.setStencilReferenceValue(newMaskConfigID);
                        gl.enable(gl.STENCIL_TEST);
                        gl.stencilFunc(gl.ALWAYS, newMaskConfigID, 0xff);
                        gl.stencilOp(gl.REPLACE, gl.REPLACE, gl.REPLACE);
                        this._mask.renderMasks(renderable.sourceEntity["hierarchicalMasks"]);
                        gl.stencilFunc(gl.EQUAL, newMaskConfigID, 0xff);
                        gl.stencilOp(gl.KEEP, gl.KEEP, gl.KEEP);
                    }
                    maskConfigID = newMaskConfigID;
                }
                //iterate through each shader object
                len = passes.length;
                for (i = 0; i < len; i++) {
                    renderable2 = renderable;
                    pass = passes[i];
                    this.activatePass(renderable, pass, camera);
                    do {
                        //console.log("Rendering normal DO " + renderable2);
                        renderable2._iRender(pass, camera, this._pRttViewProjectionMatrix);
                        renderable2 = renderable2.next;
                    } while (renderable2 && renderable2.renderObject == renderObject && renderable2.sourceEntity["maskConfigID"] === maskConfigID && renderable2.sourceEntity["hierarchicalMaskID"] === -1);
                    this.deactivatePass(renderable, pass);
                }
            }
            renderable = renderable2;
        }
    };
    Renderer2D.prototype.applyRenderable = function (renderable) {
        //set local vars for faster referencing
        var renderObject = this._pGetRenderObject(renderable, renderable.renderObjectOwner || DefaultMaterialManager.getDefaultMaterial(renderable.renderableOwner));
        renderable.renderObject = renderObject;
        renderable.renderObjectId = renderObject.renderObjectId;
        renderable.renderOrderId = renderObject.renderOrderId;
        renderable.cascaded = false;
        var entity = renderable.sourceEntity;
        renderable.zIndex = entity["hierarchicalMaskID"] === -1 ? entity.zOffset : -entity.zOffset;
        //store reference to scene transform
        renderable.renderSceneTransform = renderable.sourceEntity.getRenderSceneTransform(this._pCamera);
        if (renderObject.requiresBlending) {
            renderable.next = this._pBlendedRenderableHead;
            this._pBlendedRenderableHead = renderable;
        }
        else {
            renderable.next = this._pOpaqueRenderableHead;
            this._pOpaqueRenderableHead = renderable;
        }
        this._pNumTriangles += renderable.numTriangles;
        //handle any overflow for renderables with data that exceeds GPU limitations
        if (renderable.overflow)
            this.applyRenderable(renderable.overflow);
    };
    return Renderer2D;
})(DefaultRenderer);
module.exports = Renderer2D;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1wbGF5ZXIvbGliL3JlbmRlcmVyL1JlbmRlcmVyMkQudHMiXSwibmFtZXMiOlsiUmVuZGVyZXIyRCIsIlJlbmRlcmVyMkQuY29uc3RydWN0b3IiLCJSZW5kZXJlcjJELmRyYXdSZW5kZXJhYmxlcyIsIlJlbmRlcmVyMkQuYXBwbHlSZW5kZXJhYmxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQSxJQUFPLHNCQUFzQixXQUFXLG9EQUFvRCxDQUFDLENBQUM7QUFJOUYsSUFBTyxlQUFlLFdBQVcsdUNBQXVDLENBQUMsQ0FBQztBQU0xRSxJQUFPLElBQUksV0FBVyxpQ0FBaUMsQ0FBQyxDQUFDO0FBQ3pELElBQU8sZ0JBQWdCLFdBQVcsNkNBQTZDLENBQUMsQ0FBQztBQUVqRixJQUFNLFVBQVU7SUFBU0EsVUFBbkJBLFVBQVVBLFVBQXdCQTtJQUlwQ0EsU0FKRUEsVUFBVUEsQ0FJQUEsaUJBQTJDQSxFQUFFQSxLQUFrQkE7UUFBL0RDLGlDQUEyQ0EsR0FBM0NBLHdCQUEyQ0E7UUFBRUEscUJBQWtCQSxHQUFsQkEsWUFBa0JBO1FBRXZFQSxrQkFBTUEsaUJBQWlCQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUNoQ0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxHQUFHQSxJQUFJQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1FBQy9DQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUM5Q0EsQ0FBQ0E7SUFFTUQsb0NBQWVBLEdBQXRCQSxVQUF1QkEsVUFBeUJBLEVBQUVBLGVBQTZCQTtRQUUzRUUsSUFBSUEsQ0FBUUEsQ0FBQ0E7UUFDYkEsSUFBSUEsR0FBVUEsQ0FBQ0E7UUFDZkEsSUFBSUEsV0FBMEJBLENBQUNBO1FBQy9CQSxJQUFJQSxZQUE2QkEsQ0FBQ0E7UUFDbENBLElBQUlBLE1BQTRCQSxDQUFDQTtRQUNqQ0EsSUFBSUEsSUFBbUJBLENBQUNB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IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IENhbWVyYSA9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvZW50aXRpZXMvQ2FtZXJhXCIpO1xyXG5pbXBvcnQgQ29sbGVjdG9yQmFzZSA9IHJlcXVpcmUoXCJhd2F5anMtZGlzcGxheS9saWIvdHJhdmVyc2UvQ29sbGVjdG9yQmFzZVwiKTtcclxuaW1wb3J0IERlZmF1bHRNYXRlcmlhbE1hbmFnZXIgPSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL21hbmFnZXJzL0RlZmF1bHRNYXRlcmlhbE1hbmFnZXJcIik7XHJcbmltcG9ydCBJRW50aXR5ID0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9JRW50aXR5XCIpO1xyXG5pbXBvcnQgUmVuZGVyYWJsZU51bGxTb3J0ID0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9zb3J0L1JlbmRlcmFibGVOdWxsU29ydFwiKTtcclxuaW1wb3J0IFN0YWdlID0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL1N0YWdlXCIpO1xyXG5pbXBvcnQgRGVmYXVsdFJlbmRlcmVyID0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9EZWZhdWx0UmVuZGVyZXJcIik7XHJcbmltcG9ydCBJUmVuZGVyZXJQb29sQ2xhc3MgPSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvSVJlbmRlcmVyUG9vbENsYXNzXCIpO1xyXG5pbXBvcnQgUmVuZGVyYWJsZUJhc2UgPSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XHJcbmltcG9ydCBSZW5kZXJPYmplY3RCYXNlICAgID0gcmVxdWlyZShcImF3YXlqcy1yZW5kZXJlcmdsL2xpYi9jb21waWxhdGlvbi9SZW5kZXJPYmplY3RCYXNlXCIpO1xyXG5pbXBvcnQgUmVuZGVyUGFzc0Jhc2UgPSByZXF1aXJlKFwiYXdheWpzLXJlbmRlcmVyZ2wvbGliL3Bhc3Nlcy9SZW5kZXJQYXNzQmFzZVwiKTtcclxuXHJcbmltcG9ydCBNYXNrID0gcmVxdWlyZShcImF3YXlqcy1wbGF5ZXIvbGliL3JlbmRlcmVyL01hc2tcIik7XHJcbmltcG9ydCBSZW5kZXJhYmxlU29ydDJEID0gcmVxdWlyZShcImF3YXlqcy1wbGF5ZXIvbGliL3JlbmRlcmVyL1JlbmRlcmFibGVTb3J0MkRcIik7XHJcblxyXG5jbGFzcyBSZW5kZXJlcjJEIGV4dGVuZHMgRGVmYXVsdFJlbmRlcmVyXHJcbntcclxuICAgIHByaXZhdGUgX21hc2sgOiBNYXNrO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHJlbmRlcmVyUG9vbENsYXNzOklSZW5kZXJlclBvb2xDbGFzcyA9IG51bGwsIHN0YWdlOlN0YWdlID0gbnVsbClcclxuICAgIHtcclxuICAgICAgICBzdXBlcihyZW5kZXJlclBvb2xDbGFzcywgc3RhZ2UpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyYWJsZVNvcnRlciA9IG5ldyBSZW5kZXJhYmxlU29ydDJEKCk7XHJcbiAgICAgICAgdGhpcy5fbWFzayA9IG5ldyBNYXNrKHRoaXMuX3BTdGFnZSwgdGhpcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGRyYXdSZW5kZXJhYmxlcyhyZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBlbnRpdHlDb2xsZWN0b3I6Q29sbGVjdG9yQmFzZSlcclxuICAgIHtcclxuICAgICAgICB2YXIgaTpudW1iZXI7XHJcbiAgICAgICAgdmFyIGxlbjpudW1iZXI7XHJcbiAgICAgICAgdmFyIHJlbmRlcmFibGUyOlJlbmRlcmFibGVCYXNlO1xyXG4gICAgICAgIHZhciByZW5kZXJPYmplY3Q6UmVuZGVyT2JqZWN0QmFzZTtcclxuICAgICAgICB2YXIgcGFzc2VzOkFycmF5PFJlbmRlclBhc3NCYXNlPjtcclxuICAgICAgICB2YXIgcGFzczpSZW5kZXJQYXNzQmFzZTtcclxuICAgICAgICB2YXIgY2FtZXJhOkNhbWVyYSA9IGVudGl0eUNvbGxlY3Rvci5jYW1lcmE7XHJcbiAgICAgICAgdmFyIG1hc2tDb25maWdJRDpudW1iZXIgPSAtMTtcclxuXHJcbiAgICAgICAgLyovLyBUeXBlU2NyaXB0IGRvZXMgbm90IGFsbG93IGNhbGxpbmcgc3VwZXIuc2V0dGVycyAtXy1cclxuICAgICAgICAvL3RoaXMuX21hc2sud2lkdGggPSB0aGlzLl9wUnR0QnVmZmVyTWFuYWdlci50ZXh0dXJlV2lkdGg7XHJcbiAgICAgICAgLy90aGlzLl9tYXNrLmhlaWdodCA9IHRoaXMuX3BSdHRCdWZmZXJNYW5hZ2VyLnRleHR1cmVIZWlnaHQ7Ki9cclxuICAgICAgICB0aGlzLl9tYXNrLnJlc2V0KCk7XHJcbiAgICAgICAgdGhpcy5fcENvbnRleHQuc2V0U3RlbmNpbEFjdGlvbnMoXCJmcm9udEFuZEJhY2tcIiwgXCJhbHdheXNcIiwgXCJrZWVwXCIsIFwia2VlcFwiLCBcImtlZXBcIik7XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcIi0tLS0tLVwiKTtcclxuICAgICAgICB2YXIgZ2wgPSB0aGlzLl9wQ29udGV4dFtcIl9nbFwiXTtcclxuICAgICAgICB2YXIgZ2wgPSB0aGlzLl9wQ29udGV4dFtcIl9nbFwiXTtcclxuICAgICAgICBnbC5kaXNhYmxlKGdsLlNURU5DSUxfVEVTVCk7XHJcblxyXG4gICAgICAgIHdoaWxlIChyZW5kZXJhYmxlKSB7XHJcbiAgICAgICAgICAgIHJlbmRlck9iamVjdCA9IHJlbmRlcmFibGUucmVuZGVyT2JqZWN0O1xyXG4gICAgICAgICAgICBwYXNzZXMgPSByZW5kZXJPYmplY3QucGFzc2VzO1xyXG5cclxuICAgICAgICAgICAgaWYgKHJlbmRlcmFibGUuc291cmNlRW50aXR5W1wiaGllcmFyY2hpY2FsTWFza0lEXCJdICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgcmVuZGVyYWJsZTIgPSByZW5kZXJhYmxlLm5leHQ7XHJcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiUmVnaXN0ZXJpbmcgbWFzazogXCIgKyByZW5kZXJhYmxlLnNvdXJjZUVudGl0eVtcImhpZXJhcmNoaWNhbE1hc2tJRFwiXSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9tYXNrLnJlZ2lzdGVyTWFzayhyZW5kZXJhYmxlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBvdGhlcndpc2UgdGhpcyB3b3VsZCByZXN1bHQgaW4gZGVwdGggcmVuZGVyZWQgYW55d2F5IGJlY2F1c2UgZnJhZ21lbnQgc2hhZGVyIGtpbCBpcyBpZ25vcmVkXHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuX2Rpc2FibGVDb2xvciAmJiByZW5kZXJPYmplY3QuX3JlbmRlck9iamVjdE93bmVyLmFscGhhVGhyZXNob2xkICE9IDApIHtcclxuICAgICAgICAgICAgICAgIHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTtcclxuICAgICAgICAgICAgICAgIC8vIGZhc3QgZm9yd2FyZFxyXG4gICAgICAgICAgICAgICAgZG8ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTIubmV4dDtcclxuICAgICAgICAgICAgICAgIH0gd2hpbGUgKHJlbmRlcmFibGUyICYmIHJlbmRlcmFibGUyLnJlbmRlck9iamVjdCA9PSByZW5kZXJPYmplY3QpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIG5ld01hc2tDb25maWdJRCA9IHJlbmRlcmFibGUuc291cmNlRW50aXR5W1wibWFza0NvbmZpZ0lEXCJdO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChtYXNrQ29uZmlnSUQgIT09IG5ld01hc2tDb25maWdJRCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdNYXNrQ29uZmlnSUQgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRpc2FibGUgc3RlbmNpbFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX3BDb250ZXh0LnNldFN0ZW5jaWxBY3Rpb25zKFwiZnJvbnRBbmRCYWNrXCIsIFwiYWx3YXlzXCIsIFwia2VlcFwiLCBcImtlZXBcIiwgXCJrZWVwXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnbC5kaXNhYmxlKGdsLlNURU5DSUxfVEVTVCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsLnN0ZW5jaWxGdW5jKGdsLkFMV0FZUywgMCwgMHhmZik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsLnN0ZW5jaWxPcChnbC5LRUVQLCBnbC5LRUVQLCBnbC5LRUVQKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIkxldCdzIG5vdCB1c2Ugc3RlbmNpbCFcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiUmVuZGVyaW5nIG1hc2tzIHdpdGggY29uZmlnSUQgXCIgKyBuZXdNYXNrQ29uZmlnSUQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX3BDb250ZXh0LnNldFN0ZW5jaWxSZWZlcmVuY2VWYWx1ZShuZXdNYXNrQ29uZmlnSUQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnbC5lbmFibGUoZ2wuU1RFTkNJTF9URVNUKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ2wuc3RlbmNpbEZ1bmMoZ2wuQUxXQVlTLCBuZXdNYXNrQ29uZmlnSUQsIDB4ZmYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnbC5zdGVuY2lsT3AoZ2wuUkVQTEFDRSwgZ2wuUkVQTEFDRSwgZ2wuUkVQTEFDRSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21hc2sucmVuZGVyTWFza3MocmVuZGVyYWJsZS5zb3VyY2VFbnRpdHlbXCJoaWVyYXJjaGljYWxNYXNrc1wiXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsLnN0ZW5jaWxGdW5jKGdsLkVRVUFMLCBuZXdNYXNrQ29uZmlnSUQsIDB4ZmYpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBnbC5zdGVuY2lsT3AoZ2wuS0VFUCwgZ2wuS0VFUCwgZ2wuS0VFUCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcy5fcENvbnRleHQuc2V0U3RlbmNpbEFjdGlvbnMoXCJmcm9udEFuZEJhY2tcIiwgXCJlcXVhbFwiLCBcImtlZXBcIiwgXCJrZWVwXCIsIFwia2VlcFwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbWFza0NvbmZpZ0lEID0gbmV3TWFza0NvbmZpZ0lEO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vaXRlcmF0ZSB0aHJvdWdoIGVhY2ggc2hhZGVyIG9iamVjdFxyXG4gICAgICAgICAgICAgICAgbGVuID0gcGFzc2VzLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcGFzcyA9IHBhc3Nlc1tpXTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmF0ZVBhc3MocmVuZGVyYWJsZSwgcGFzcywgY2FtZXJhKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZG8ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiUmVuZGVyaW5nIG5vcm1hbCBETyBcIiArIHJlbmRlcmFibGUyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyYWJsZTIuX2lSZW5kZXIocGFzcywgY2FtZXJhLCB0aGlzLl9wUnR0Vmlld1Byb2plY3Rpb25NYXRyaXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJhYmxlMiA9IHJlbmRlcmFibGUyLm5leHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocmVuZGVyYWJsZTIgJiYgcmVuZGVyYWJsZTIucmVuZGVyT2JqZWN0ID09IHJlbmRlck9iamVjdCAmJiByZW5kZXJhYmxlMi5zb3VyY2VFbnRpdHlbXCJtYXNrQ29uZmlnSURcIl0gPT09IG1hc2tDb25maWdJRCAmJiByZW5kZXJhYmxlMi5zb3VyY2VFbnRpdHlbXCJoaWVyYXJjaGljYWxNYXNrSURcIl0gPT09IC0xKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWFjdGl2YXRlUGFzcyhyZW5kZXJhYmxlLCBwYXNzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmVuZGVyYWJsZSA9IHJlbmRlcmFibGUyO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXBwbHlSZW5kZXJhYmxlKHJlbmRlcmFibGU6UmVuZGVyYWJsZUJhc2UpXHJcbiAgICB7XHJcbiAgICAgICAgLy9zZXQgbG9jYWwgdmFycyBmb3IgZmFzdGVyIHJlZmVyZW5jaW5nXHJcbiAgICAgICAgdmFyIHJlbmRlck9iamVjdDpSZW5kZXJPYmplY3RCYXNlID0gdGhpcy5fcEdldFJlbmRlck9iamVjdChyZW5kZXJhYmxlLCByZW5kZXJhYmxlLnJlbmRlck9iamVjdE93bmVyIHx8IERlZmF1bHRNYXRlcmlhbE1hbmFnZXIuZ2V0RGVmYXVsdE1hdGVyaWFsKHJlbmRlcmFibGUucmVuZGVyYWJsZU93bmVyKSk7XHJcblxyXG4gICAgICAgIHJlbmRlcmFibGUucmVuZGVyT2JqZWN0ID0gcmVuZGVyT2JqZWN0O1xyXG4gICAgICAgIHJlbmRlcmFibGUucmVuZGVyT2JqZWN0SWQgPSByZW5kZXJPYmplY3QucmVuZGVyT2JqZWN0SWQ7XHJcbiAgICAgICAgcmVuZGVyYWJsZS5yZW5kZXJPcmRlcklkID0gcmVuZGVyT2JqZWN0LnJlbmRlck9yZGVySWQ7XHJcblxyXG4gICAgICAgIHJlbmRlcmFibGUuY2FzY2FkZWQgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgdmFyIGVudGl0eTpJRW50aXR5ID0gcmVuZGVyYWJsZS5zb3VyY2VFbnRpdHk7XHJcbiAgICAgICAgcmVuZGVyYWJsZS56SW5kZXggPSBlbnRpdHlbXCJoaWVyYXJjaGljYWxNYXNrSURcIl0gPT09IC0xPyBlbnRpdHkuek9mZnNldCA6IC1lbnRpdHkuek9mZnNldDtcclxuXHJcbiAgICAgICAgLy9zdG9yZSByZWZlcmVuY2UgdG8gc2NlbmUgdHJhbnNmb3JtXHJcbiAgICAgICAgcmVuZGVyYWJsZS5yZW5kZXJTY2VuZVRyYW5zZm9ybSA9IHJlbmRlcmFibGUuc291cmNlRW50aXR5LmdldFJlbmRlclNjZW5lVHJhbnNmb3JtKHRoaXMuX3BDYW1lcmEpO1xyXG5cclxuICAgICAgICBpZiAocmVuZGVyT2JqZWN0LnJlcXVpcmVzQmxlbmRpbmcpIHtcclxuICAgICAgICAgICAgcmVuZGVyYWJsZS5uZXh0ID0gdGhpcy5fcEJsZW5kZWRSZW5kZXJhYmxlSGVhZDtcclxuICAgICAgICAgICAgdGhpcy5fcEJsZW5kZWRSZW5kZXJhYmxlSGVhZCA9IHJlbmRlcmFibGU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVuZGVyYWJsZS5uZXh0ID0gdGhpcy5fcE9wYXF1ZVJlbmRlcmFibGVIZWFkO1xyXG4gICAgICAgICAgICB0aGlzLl9wT3BhcXVlUmVuZGVyYWJsZUhlYWQgPSByZW5kZXJhYmxlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fcE51bVRyaWFuZ2xlcyArPSByZW5kZXJhYmxlLm51bVRyaWFuZ2xlcztcclxuXHJcbiAgICAgICAgLy9oYW5kbGUgYW55IG92ZXJmbG93IGZvciByZW5kZXJhYmxlcyB3aXRoIGRhdGEgdGhhdCBleGNlZWRzIEdQVSBsaW1pdGF0aW9uc1xyXG4gICAgICAgIGlmIChyZW5kZXJhYmxlLm92ZXJmbG93KVxyXG4gICAgICAgICAgICB0aGlzLmFwcGx5UmVuZGVyYWJsZShyZW5kZXJhYmxlLm92ZXJmbG93KTtcclxuICAgIH1cclxuXHJcbiAgICAvKnB1YmxpYyBkaXNwb3NlKClcclxuICAgIHtcclxuICAgICAgICBzdXBlci5kaXNwb3NlKCk7XHJcbiAgICAgICAgdGhpcy5fbWFzay5kaXNwb3NlKCk7XHJcbiAgICB9Ki9cclxufVxyXG5leHBvcnQgPSBSZW5kZXJlcjJEOyJdfQ==